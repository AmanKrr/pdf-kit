import{toShapeAnnos}from"../../utils/annotation-utils";class AnnotationService{constructor(t,n){this._annotations=new Map,this._annotationManagers=new Map,this._onCreated=t=>this._updateAnnotationMap(t),this._onDeleted=t=>this._deleteAnnotation(t),this._pdfState=t,this._goTo=n.goToPage.bind(n),t.on("ANNOTATION_CREATED",this._onCreated),t.on("ANNOTATION_DELETED",this._onDeleted)}isAnnotationManagerRegistered(t){return this._annotationManagers.get(t)}registerAnnotationManager(t,n){this._annotationManagers.set(t,n),this._pdfState.isAnnotationEnabled&&this._pdfState.isAnnotationConfigurationPropertiesEnabled&&n._initAnnotation();t=this._annotations.get(t);if(t)for(var a of t)n.addAnnotation(a,!1,!1===a.interactive)}unregisterAnnotationManager(t){var n=this._annotationManagers.get(t);null!=n&&n.destroy(),this._annotationManagers.delete(t),this._pdfState.isAnnotationEnabled&&this._pdfState.isAnnotationConfigurationPropertiesEnabled&&null!=n&&n._initAnnotationCleanup()}addAnnotation(t){var t=Object.assign(Object.assign({},t),{id:this._generateUniqueId(),interactive:!1}),n=t.pageNumber,a=(this._goTo(n),null!=(a=this._annotations.get(n))?a:[]),a=(a.push(t),this._annotations.set(n,a),this._annotationManagers.get(n));return a&&a.addAnnotation(t,!0,!0),t.id}updateAnnotation(n,t){for(var[a,o]of this._annotations.entries()){var e=o.findIndex(t=>t.id===n);if(-1!==e)return o[e]=Object.assign(Object.assign({},o[e]),t),void(null!=(a=this._annotationManagers.get(a))&&a.updateAnnotation(o[e]))}throw new Error("Annotation not found")}deleteAnnotation(t){this._deleteAnnotation(t)}exportShapes(){var t=this._collectAllConfigs();return toShapeAnnos(t,this._pdfState.scale)}destroy(){this._pdfState.off("ANNOTATION_CREATED",this._onCreated),this._pdfState.off("ANNOTATION_DELETED",this._onDeleted);for(var t of this._annotationManagers.values())t.destroy();this._annotationManagers.clear(),this._annotations.clear()}_deleteAnnotation(n){for(var[t,a]of this._annotations.entries()){var o=a.findIndex(t=>t.id===n);if(-1!==o)return a.splice(o,1),void(null!=(a=this._annotationManagers.get(t))&&a.deleteAnnotation(n))}throw new Error("Annotation not found")}_updateAnnotationMap(n){if(null==n.pageNumber)throw new Error("Page number not found!");var t=n.pageNumber,a=this._annotations.get(t)||[],o=a.findIndex(t=>t.id===n.id);0<=o?a[o]=n:a.push(n),this._annotations.set(t,a)}_collectAllConfigs(){var t,n=[];for(t of this._annotationManagers.values())n.push(...t.getAnnotations.map(t=>t.getConfig()));return n}_generateUniqueId(){return"anno-"+Math.random().toString(36).substr(2,9)+"-"+Date.now().toString()}}export{AnnotationService};
var __awaiter=this&&this.__awaiter||function(t,n,d,c){return new(d=d||Promise)(function(o,e){function r(t){try{a(c.next(t))}catch(t){e(t)}}function i(t){try{a(c.throw(t))}catch(t){e(t)}}function a(t){var e;t.done?o(t.value):((e=t.value)instanceof d?e:new d(function(t){t(e)})).then(r,i)}a((c=c.apply(t,n||[])).next())})};import{PDFDocument,rgb}from"pdf-lib";import{normalizeColor}from"../../utils/annotation-utils";class PdfExportService{buildAnnotatedPdf(v,g,u){return __awaiter(this,void 0,void 0,function*(){var t,e=yield PDFDocument.load(v);for(t of g){var o=e.getPage(t.page-1),r=u.get(t.page);if(r){var[i,a,n]=PdfExportService._hexToRgb(t.stroke),d=normalizeColor(t.fill),c=d?PdfExportService._hexToRgb(d):void 0,s=this._cssPxToPt(t.strokeWidth),l=null!=(d=t.opacity)?d:1;switch(t.kind){case"rectangle":var f=PdfExportService._toPdfRect(r,t);o.drawRectangle({x:f.x,y:f.y,width:f.width,height:f.height,borderColor:rgb(i,a,n),borderWidth:s,color:c?rgb(...c):void 0,opacity:l,borderOpacity:l});break;case"ellipse":f=PdfExportService._toPdfRect(r,t);o.drawEllipse({x:f.x+f.width/2,y:f.y+f.height/2,xScale:f.width/2,yScale:f.height/2,borderColor:rgb(i,a,n),borderWidth:s,color:c?rgb(...c):void 0,opacity:l,borderOpacity:l});break;case"line":var[h,p]=PdfExportService._toPdfPoint(r,t.x1,t.y1),[P,x]=PdfExportService._toPdfPoint(r,t.x2,t.y2);o.drawLine({start:{x:h,y:p},end:{x:P,y:x},thickness:s,color:rgb(i,a,n),opacity:l});break;default:console.warn("Unsupported annotation kind:",t.kind)}}else console.warn(`Skipping annotation on page ${t.page}: Viewport not found.`)}return e.save({useObjectStreams:!1})})}_cssPxToPt(t,e=96){return t/e*72}static _toPdfPoint(t,e,o){return t.convertToPdfPoint(e,o)}static _toPdfRect(t,e){var[o,r]=t.convertToPdfPoint(e.x,e.y),[t,e]=t.convertToPdfPoint(e.x+e.width,e.y+e.height);return{x:Math.min(o,t),y:Math.min(r,e),width:Math.abs(t-o),height:Math.abs(e-r)}}static _hexToRgb(t){var e,o,r,i,a=[1,0,0];return"string"!=typeof t?(console.error("Invalid hex color: "+t),a):(t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(t,e,o,r)=>"#"+e+e+o+o+r+r),(o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t))?([e,o,r,i]=o,[parseInt(o,16)/255,parseInt(r,16)/255,parseInt(i,16)/255]):(console.error("Failed to parse hex color: "+t),a))}}export{PdfExportService};
var __awaiter=this&&this.__awaiter||function(e,s,h,n){return new(h=h||Promise)(function(r,t){function a(e){try{l(n.next(e))}catch(e){t(e)}}function i(e){try{l(n.throw(e))}catch(e){t(e)}}function l(e){var t;e.done?r(e.value):((t=e.value)instanceof h?t:new h(function(e){e(t)})).then(a,i)}l((n=n.apply(e,s||[])).next())})};import SearchIndexManager from"./SearchIndexManager";class SearchHighlighter{constructor(){this.currentSearchTerm="",this.currentOptions={matchCase:!1,wholeWord:!1,regex:!1},this.flatResults=[],this.allFlatResults=[],this.currentMatchIndex=-1,this.pdfViewer=null}set viewer(e){this.pdfViewer=e}search(c,o,u){return __awaiter(this,void 0,void 0,function*(){if(this.currentSearchTerm=c,this.currentOptions=o,this.flatResults=[],this.removeHighlights(),!c)return[];var e,t,r=[];let a=SearchIndexManager.getAllPageNumbers();0===a.length&&(yield this.extractPdfContent(u.pdfInstance.numPages,u.pdfInstance),a=SearchIndexManager.getAllPageNumbers());for(e of a){var i=SearchIndexManager.getPageText(e);if(i){for(var l,s=this.buildRegex(c,o),h=[];null!==(l=s.exec(i));)h.push({startIndex:l.index,length:l[0].length});0<h.length&&(r.push({pageNumber:e,matchPositions:h}),yield this.highlightPage(e,c,o))}}this.allFlatResults=[];for(t of r)for(var n of t.matchPositions)this.allFlatResults.push({pageNumber:t.pageNumber,matchPosition:n});return this.allFlatResults.sort((e,t)=>e.pageNumber!==t.pageNumber?e.pageNumber-t.pageNumber:e.matchPosition.startIndex-t.matchPosition.startIndex),0<this.flatResults.length&&this.selectMatch(0),r})}extractPdfContent(r,a){return __awaiter(this,void 0,void 0,function*(){for(let e=1;e<=r;e++){var t=yield a.getPage(e);yield SearchIndexManager.extractPageText(e,t)}})}buildRegex(e,t){var r;return t.regex?new RegExp(e,t.matchCase?"g":"gi"):(e=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=t.wholeWord?"\\b":"",new RegExp(r+e+r,t.matchCase?"g":"gi"))}highlightPage(t,r,a){return __awaiter(this,void 0,void 0,function*(){var e=yield this.waitForPageContainer(t);e&&(e=e.querySelector(".a-text-layer"))&&(e.querySelectorAll('span[role="presentation"]').forEach(e=>{var t;e.textContent&&(t=this.buildRegex(r,a),e.innerHTML=e.textContent.replace(t,e=>`<span class="search-highlight" style="position: relative; display: inline-block;">${e}</span>`))}),Array.from(e.querySelectorAll(".search-highlight")).forEach(e=>{this.flatResults.push({pageNumber:t,element:e})}))})}waitForPageContainer(i){return new Promise(t=>{let r=0,a=()=>{var e=document.getElementById("pageContainer-"+i);e?t(e):.2<=++r?t(null):setTimeout(a,100)};a()})}removeHighlights(){document.querySelectorAll(".a-text-layer").forEach(e=>{e.querySelectorAll('span[role="presentation"]').forEach(e=>{e.textContent&&(e.innerHTML=e.textContent)})}),this.flatResults=[],this.currentMatchIndex=-1}registerPage(e){return __awaiter(this,void 0,void 0,function*(){this.currentSearchTerm&&(yield this.highlightPage(e,this.currentSearchTerm,this.currentOptions))})}deregisterPage(t){var e=document.getElementById("pageContainer-"+t);e&&(e=e.querySelector(".a-text-layer"))&&e.querySelectorAll(".search-highlight").forEach(e=>{e.classList.remove("search-highlight")}),this.flatResults=this.flatResults.filter(e=>e.pageNumber!==t)}selectMatch(e){if(0!==this.allFlatResults.length){this.currentMatchIndex=e;let r=this.allFlatResults[e];if(r)if(!document.getElementById("pageContainer-"+r.pageNumber)&&this.pdfViewer)return this.pdfViewer.goToPage(r.pageNumber),void setTimeout(()=>{this.selectMatch(e)},300);this.waitForPageContainer(r.pageNumber).then(e=>{var t;e&&(e=e.querySelector(".a-text-layer"))&&(t=(e=Array.from(e.querySelectorAll(".search-highlight")))[this.allFlatResults.filter(e=>e.pageNumber===r.pageNumber&&e.matchPosition.startIndex<r.matchPosition.startIndex).length])&&(e.forEach(e=>e.classList.remove("a-active-highlight")),t.classList.add("a-active-highlight"),t.scrollIntoView({behavior:"smooth",block:"center"}))})}}nextMatch(){var e;0!==this.allFlatResults.length&&(e=(this.currentMatchIndex+1)%this.allFlatResults.length,this.selectMatch(e))}prevMatch(){var e;0!==this.allFlatResults.length&&(e=(this.currentMatchIndex-1+this.allFlatResults.length)%this.allFlatResults.length,this.selectMatch(e))}getMatchStatus(){return{current:0<this.allFlatResults.length&&0<=this.currentMatchIndex?this.currentMatchIndex+1:0,total:this.allFlatResults.length}}}export default new SearchHighlighter;
var __awaiter=this&&this.__awaiter||function(e,l,h,n){return new(h=h||Promise)(function(a,t){function r(e){try{s(n.next(e))}catch(e){t(e)}}function i(e){try{s(n.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?a(e.value):((t=e.value)instanceof h?t:new h(function(e){e(t)})).then(r,i)}s((n=n.apply(e,l||[])).next())})};import SearchIndexManager from"./SearchIndexManager";class SearchHighlighter{constructor(e,t){this._currentSearchTerm="",this._currentOptions={matchCase:!1,wholeWord:!1,regex:!1},this._flatResults=[],this._allFlatResults=[],this._currentMatchIndex=-1,this._pdfState=e,this._pdfViewer=t,this._searchIndexManager=new SearchIndexManager}search(o,c,u){return __awaiter(this,void 0,void 0,function*(){if(this._currentSearchTerm=o,this._currentOptions=c,this._flatResults=[],this.removeHighlights(),!o)return[];var e,t,a=[];let r=this._searchIndexManager.getAllPageNumbers();0===r.length&&(yield this.extractPdfContent(u.pdfInstance.numPages,u.pdfInstance),r=this._searchIndexManager.getAllPageNumbers());for(e of r){var i=this._searchIndexManager.getPageText(e);if(i){for(var s,l=this._buildRegex(o,c),h=[];null!==(s=l.exec(i));)h.push({startIndex:s.index,length:s[0].length});0<h.length&&(a.push({pageNumber:e,matchPositions:h}),yield this.highlightPage(e,o,c))}}this._allFlatResults=[];for(t of a)for(var n of t.matchPositions)this._allFlatResults.push({pageNumber:t.pageNumber,matchPosition:n});return this._allFlatResults.sort((e,t)=>e.pageNumber!==t.pageNumber?e.pageNumber-t.pageNumber:e.matchPosition.startIndex-t.matchPosition.startIndex),0<this._flatResults.length&&this.selectMatch(0),a})}extractPdfContent(a,r){return __awaiter(this,void 0,void 0,function*(){for(let e=1;e<=a;e++){var t=yield r.getPage(e);yield this._searchIndexManager.extractPageText(e,t)}})}_buildRegex(e,t){var a;return t.regex?new RegExp(e,t.matchCase?"g":"gi"):(e=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=t.wholeWord?"\\b":"",new RegExp(a+e+a,t.matchCase?"g":"gi"))}highlightPage(t,a,r){return __awaiter(this,void 0,void 0,function*(){var e=yield this._waitForPageContainer(t);e&&(e=e.querySelector(".a-text-layer"))&&(e.querySelectorAll('span[role="presentation"]').forEach(e=>{var t;e.textContent&&(t=this._buildRegex(a,r),e.innerHTML=e.textContent.replace(t,e=>`<span class="search-highlight" style="position: relative; display: inline-block;">${e}</span>`))}),Array.from(e.querySelectorAll(".search-highlight")).forEach(e=>{this._flatResults.push({pageNumber:t,element:e})}))})}_waitForPageContainer(i){return new Promise(t=>{let a=0,r=()=>{var e=document.querySelector(`#${null==(e=this._pdfState)?void 0:e.containerId} #pageContainer-`+i);e?t(e):.2<=++a?t(null):setTimeout(r,100)};r()})}removeHighlights(){var e;document.querySelectorAll(`#${null==(e=this._pdfState)?void 0:e.containerId} .a-text-layer`).forEach(e=>{e.querySelectorAll('span[role="presentation"]').forEach(e=>{e.textContent&&(e.innerHTML=e.textContent)})}),this._flatResults=[],this._currentMatchIndex=-1}registerPage(e){return __awaiter(this,void 0,void 0,function*(){this._currentSearchTerm&&(yield this.highlightPage(e,this._currentSearchTerm,this._currentOptions))})}deregisterPage(t){var e=document.querySelector(`#${null==(e=this._pdfState)?void 0:e.containerId} #pageContainer-`+t);e&&(e=e.querySelector(".a-text-layer"))&&e.querySelectorAll(".search-highlight").forEach(e=>{e.classList.remove("search-highlight")}),this._flatResults=this._flatResults.filter(e=>e.pageNumber!==t)}selectMatch(e){var t;if(0!==this._allFlatResults.length){this._currentMatchIndex=e;let a=this._allFlatResults[e];if(a)if(!document.querySelector(`#${null==(t=this._pdfState)?void 0:t.containerId} #pageContainer-`+a.pageNumber)&&this._pdfViewer)return this._pdfViewer.goToPage(a.pageNumber),void setTimeout(()=>{this.selectMatch(e)},300);this._waitForPageContainer(a.pageNumber).then(e=>{var t;e&&(e=e.querySelector(".a-text-layer"))&&(t=(e=Array.from(e.querySelectorAll(".search-highlight")))[this._allFlatResults.filter(e=>e.pageNumber===a.pageNumber&&e.matchPosition.startIndex<a.matchPosition.startIndex).length])&&(e.forEach(e=>e.classList.remove("a-active-highlight")),t.classList.add("a-active-highlight"),t.scrollIntoView({behavior:"smooth",block:"center"}))})}}nextMatch(){var e;0!==this._allFlatResults.length&&(e=(this._currentMatchIndex+1)%this._allFlatResults.length,this.selectMatch(e))}prevMatch(){var e;0!==this._allFlatResults.length&&(e=(this._currentMatchIndex-1+this._allFlatResults.length)%this._allFlatResults.length,this.selectMatch(e))}getMatchStatus(){return{current:0<this._allFlatResults.length&&0<=this._currentMatchIndex?this._currentMatchIndex+1:0,total:this._allFlatResults.length}}}export default SearchHighlighter;
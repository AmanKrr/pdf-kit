var __awaiter=this&&this.__awaiter||function(e,o,c,s){return new(c=c||Promise)(function(r,t){function i(e){try{a(s.next(e))}catch(e){t(e)}}function n(e){try{a(s.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?r(e.value):((t=e.value)instanceof c?t:new c(function(e){e(t)})).then(i,n)}a((s=s.apply(e,o||[])).next())})};import{PdfExportService}from"../services/AnnotationExportService";class DownloadManager{constructor(e,t,r,i=!1){this._annotationService=e,this._pdfState=t,this._sourceUrl=r,this._cacheSource=i}download(){return __awaiter(this,arguments,void 0,function*(e=""){var[t,r]=yield Promise.all([this._getOriginalBytes(),this._buildViewportMap()]),i=this._annotationService.exportShapes(),t=yield(new PdfExportService).buildAnnotatedPdf(t,i,r);this._triggerBrowserDownload(t,e||Date.now().toString())})}_getOriginalBytes(){return __awaiter(this,void 0,void 0,function*(){var e=this._pdfState.pdfInstance;if(null!=e&&e.getData)return e=(yield e.getData()).buffer,this._cacheSource?e:e.slice(0);if(this._sourceUrl)return e=yield fetch(this._sourceUrl).then(e=>e.arrayBuffer()),this._cacheSource?e:e.slice(0);throw new Error("DownloadManager: sourceUrl required when pdf.js cannot provide bytes.")})}_buildViewportMap(){return __awaiter(this,void 0,void 0,function*(){var t=this._pdfState.pdfInstance,r=this._pdfState.scale,i=new Map;for(let e=1;e<=t.numPages;e++){var n=(yield t.getPage(e)).getViewport({scale:r});i.set(e,n)}return i})}_triggerBrowserDownload(e,t){e=new Blob([e],{type:"application/pdf"});let r=Object.assign(document.createElement("a"),{href:URL.createObjectURL(e),download:t});r.click(),setTimeout(()=>URL.revokeObjectURL(r.href),0)}}export{DownloadManager};
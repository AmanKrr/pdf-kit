var __rest=this&&this.__rest||function(t,n){var e={};for(i in t)Object.prototype.hasOwnProperty.call(t,i)&&n.indexOf(i)<0&&(e[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,i=Object.getOwnPropertySymbols(t);o<i.length;o++)n.indexOf(i[o])<0&&Object.prototype.propertyIsEnumerable.call(t,i[o])&&(e[i[o]]=t[i[o]]);return e};import{AnnotationFactory}from"../annotations/PDFAnnotationFactory";class AnnotationManager{constructor(t,n,e){this._pdfState=null,this._annotations=[],this._activeAnnotation=null,this._selectedAnnotation=null,this._drawConfig={fillColor:"transparent",strokeColor:"red",strokeWidth:2,strokeStyle:"solid",opacity:1,type:"rectangle"},this._boundMouseDown=this._onMouseDown.bind(this),this._boundMouseMove=this._onMouseMove.bind(this),this._boundMouseUp=this._onMouseUp.bind(this),this._boundInitMouseDown=this._initMouseDown.bind(this),this._boundAnnotationSelection=this._onAnnotationSelection.bind(this),this._annotationDrawerContainer=t,this._pdfState=n,this._selectionManager=e,this._selectionUnsubscribe=e.onSelectionChange(t=>{!this._selectedAnnotation||t&&this._selectedAnnotation.annotationId===t.id||this.deselectAll()}),this._pdfState.on("ANNOTATION_SELECTED",this._boundAnnotationSelection)}set drawConfig(t){this._drawConfig=Object.assign({},t)}set pdfState(t){this._pdfState=t}get getAnnotations(){return this._annotations}get getActiveAnnotation(){return this._activeAnnotation}get getSelectedAnnoation(){return this._selectedAnnotation}_initAnnotation(){this._annotationDrawerContainer&&this._annotationDrawerContainer.addEventListener("mousedown",this._boundInitMouseDown)}_initAnnotationCleanup(){this._annotationDrawerContainer&&this._annotationDrawerContainer.removeEventListener("mousedown",this._boundInitMouseDown)}_addListeners(){this._annotationDrawerContainer&&this._annotationDrawerContainer.parentElement&&this._annotationDrawerContainer.parentElement.parentElement&&(this._annotationDrawerContainer.parentElement.parentElement.addEventListener("mousedown",this._boundMouseDown),this._annotationDrawerContainer.parentElement.parentElement.addEventListener("mousemove",this._boundMouseMove),this._annotationDrawerContainer.parentElement.parentElement.addEventListener("mouseup",this._boundMouseUp))}_removeListeners(){this._annotationDrawerContainer&&this._annotationDrawerContainer.parentElement&&this._annotationDrawerContainer.parentElement.parentElement&&(this._annotationDrawerContainer.parentElement.parentElement.removeEventListener("mousedown",this._boundMouseDown),this._annotationDrawerContainer.parentElement.parentElement.removeEventListener("mousemove",this._boundMouseMove),this._annotationDrawerContainer.parentElement.parentElement.removeEventListener("mouseup",this._boundMouseUp))}_initMouseDown(){var t=this._drawConfig,n=t.type,t=__rest(t,["type"]);this.createShape(n,t)}_onMouseDown(t){var n,e;this._annotationDrawerContainer&&this._activeAnnotation&&this._pdfState&&(t.target?(t.preventDefault(),e=this._annotationDrawerContainer.getBoundingClientRect(),n=t.clientX-e.left,e=t.clientY-e.top,t=null==(t=null==(t=null==(t=null==(t=null==t?void 0:t.target)?void 0:t.parentElement)?void 0:t.id)?void 0:t.split("-"))?void 0:t[1],this._activeAnnotation.startDrawing(n,e,t?parseInt(t):this._pdfState.currentPage)):console.error("Failed to draw annotation. Target not found."))}_onMouseMove(t){var n,e;this._annotationDrawerContainer&&this._activeAnnotation&&this._activeAnnotation.isDrawing&&(t.preventDefault(),n=this._annotationDrawerContainer.getBoundingClientRect(),e=t.clientX-n.left,this._activeAnnotation.updateDrawing(e,t.clientY-n.top))}_onMouseUp(){this._activeAnnotation&&(this._activeAnnotation.stopDrawing(),this._removeListeners(),this._onAnnotationSelection(this._activeAnnotation.getConfig()),this._activeAnnotation=null,this.setPointerEvent("none"))}setPointerEvent(t){this._annotationDrawerContainer&&(this._annotationDrawerContainer.style.pointerEvents=t)}createShape(t,n={}){this._annotationDrawerContainer&&this._pdfState&&(this.deselectAll(),this._addListeners(),this._activeAnnotation=AnnotationFactory.createAnnotation({type:t,annotationDrawerContainer:this._annotationDrawerContainer,pdfState:this._pdfState,fillColor:null!=(t=n.fillColor)?t:this._drawConfig.fillColor,strokeColor:null!=(t=n.strokeColor)?t:this._drawConfig.strokeColor,strokeWidth:null!=(t=n.strokeWidth)?t:this._drawConfig.strokeWidth,strokeStyle:null!=(t=n.strokeStyle)?t:this._drawConfig.strokeStyle,opacity:null!=(t=n.opacity)?t:this._drawConfig.opacity,id:null==n?void 0:n.id}),this._annotations.push(this._activeAnnotation))}_drawShape(t,n){var e,o;if(this._annotationDrawerContainer&&this._pdfState)return o=AnnotationFactory.createAnnotation({type:t.type,annotationDrawerContainer:this._annotationDrawerContainer,pdfState:this._pdfState,fillColor:null!=(o=t.fillColor)?o:this._drawConfig.fillColor,strokeColor:null!=(o=t.strokeColor)?o:this._drawConfig.strokeColor,strokeWidth:null!=(o=t.strokeWidth)?o:this._drawConfig.strokeWidth,strokeStyle:null!=(o=t.strokeStyle)?o:this._drawConfig.strokeStyle,opacity:null!=(o=t.opacity)?o:this._drawConfig.opacity,id:t.id}),"rectangle"===t.type?o.draw(null!=(e=t.x0)?e:0,null!=(e=t.x1)?e:0,null!=(e=t.y0)?e:0,null!=(e=t.y1)?e:0,t.pageNumber):"ellipse"===t.type?o.draw(null!=(e=t.cx)?e:0,null!=(e=t.cy)?e:0,null!=(e=t.rx)?e:0,null!=(e=t.ry)?e:0,t.pageNumber):"line"===t.type&&o.draw(null!=(e=t.x1)?e:0,null!=(e=t.y1)?e:0,null!=(e=t.x2)?e:0,null!=(e=t.y2)?e:0,t.pageNumber),n&&o.revokeSelection(),this._annotations.push(o),this._activeAnnotation=null,this.setPointerEvent("none"),o}addAnnotation(n,t=!1,e=!1){this._annotations.some(t=>t.annotationId===n.id)||((e=this._drawShape(n,e))?(t&&e.scrollToView&&e.scrollToView(),e.deselect()):console.error("Failed to create annotation"))}updateAnnotation(t){console.log("updateAnnotation not implemented in AnnotationManager")}deleteAnnotation(n){var t=this._annotations.findIndex(t=>t.annotationId===n);-1<t&&(this._annotations[t].deleteAnnotation(!0),this._annotations.splice(t,1))}selectAnnotation(t){this.deselectAll(),t.select(),this._selectedAnnotation=t,this._selectionManager.setSelected({id:t.annotationId,type:t.type})}deselectAll(){this._annotations.forEach(t=>t.deselect()),this._selectedAnnotation=null}_onAnnotationSelection(n){if(null==n.id)throw Error("annotation id missing!");var t=this._annotations.find(t=>t.annotationId===n.id);t&&this.selectAnnotation(t)}destroy(){var t;this._removeListeners(),this._selectionUnsubscribe&&this._selectionUnsubscribe(),null!=(t=this._pdfState)&&t.off("ANNOTATION_SELECTED",this._boundAnnotationSelection),this._annotationDrawerContainer=null,this._activeAnnotation=null,this._selectedAnnotation=null}}export{AnnotationManager};
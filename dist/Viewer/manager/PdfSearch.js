var __awaiter=this&&this.__awaiter||function(t,i,s,c){return new(s=s||Promise)(function(a,e){function n(t){try{r(c.next(t))}catch(t){e(t)}}function h(t){try{r(c.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?a(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(n,h)}r((c=c.apply(t,i||[])).next())})};import{aPdfViewerClassNames}from"../../constant/ElementIdClass";import Trie from"./Trie";class PdfSearch{constructor(t,e){this.textIndex=new Map,this.trie=new Trie,this.currentMatchIndex=-1,this.matches=[],this.foundMatches=[],this.matchCounterElement=null,this.upButtonElement=null,this.downButtonElement=null,this.searchInputElement=null,this.currentSearchTerm="",this.currentSearchOptions={matchCase:!1,wholeWord:!1,regex:!1},this.pdfState=t,this.pdfViewer=e,this.createSearchLayout()}extractPdfContent(){return __awaiter(this,void 0,void 0,function*(){for(let t=1;t<=this.pdfState.pdfInstance.numPages;t++)yield this.extractPageText(t)})}waitForPageContainer(n){return new Promise(e=>{let a=()=>{var t=document.querySelector("#pageContainer-"+n);t?e(t):setTimeout(a,100)};a()})}extractPageText(e){return __awaiter(this,void 0,void 0,function*(){var t;this.textIndex.has(e)||(t=(yield(yield this.pdfState.pdfInstance.getPage(e)).getTextContent()).items.map(t=>""!==t.str?t.str:"@REMOVE-1-1").filter(t=>"@REMOVE-1-1"!==t).join(" "),this.textIndex.set(e,t),t.split(/\s+/).forEach(t=>this.trie.insert(t)))})}search(i,s){return __awaiter(this,void 0,void 0,function*(){if(this.currentSearchTerm=i,this.currentSearchOptions=s,this.removeHighlights(),!i)return[];0===this.textIndex.size&&(yield this.extractPdfContent()),this.matches=[];for(var[e,a]of this.textIndex){var n;let t=0;for(var h=[],r=this.constructSearchPattern(i,s);null!==(n=r.exec(a));)h.push({startIndex:n.index,length:n[0].length}),t++;0<t&&this.matches.push({pageNumber:e,totalMatches:t,matchPositions:h})}for(var t of this.matches)yield this.highlightInlineMatchesForPage(t.pageNumber,i,s);return this.matchCounterElement&&(this.matchCounterElement.textContent=`${0<this.foundMatches.length?1:0} / `+this.foundMatches.length),0<this.foundMatches.length&&this.selectMatch(0),this.matches})}removeHighlights(){document.querySelectorAll(".a-text-layer").forEach(t=>{t.querySelectorAll('span[role="presentation"]').forEach(t=>{t.textContent&&(t.innerHTML=t.textContent)})}),this.matches=[],this.foundMatches=[],this.currentMatchIndex=-1,this.matchCounterElement&&(this.matchCounterElement.textContent="0/0")}constructSearchPattern(t,e){var a;return e.regex?new RegExp(t,e.matchCase?"g":"gi"):(t=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=e.wholeWord?"\\b":"",new RegExp(a+t+a,e.matchCase?"g":"gi"))}highlightInlineMatchesForPage(e,a,n){return __awaiter(this,void 0,void 0,function*(){var t=(yield this.waitForPageContainer(e)).querySelector(".a-text-layer");t&&(t.querySelectorAll('span[role="presentation"]').forEach(t=>{var e;t.textContent&&(e=this.constructSearchPattern(a,n),t.innerHTML=t.textContent.replace(e,t=>`<span class="search-highlight">${t}</span>`))}),this.foundMatches=this.foundMatches.filter(t=>t.pageNumber!==e),Array.from(t.querySelectorAll(".search-highlight")).forEach(t=>{this.foundMatches.push({pageNumber:e,highlights:[t],matchPosition:{startIndex:0,length:t.textContent?t.textContent.length:0}})}))})}refreshInlineHighlightsForPage(t){return __awaiter(this,void 0,void 0,function*(){yield this.highlightInlineMatchesForPage(t,this.currentSearchTerm,this.currentSearchOptions)})}selectMatch(t){if(0!==this.foundMatches.length){this.foundMatches.forEach(t=>{t.highlights.forEach(t=>t.classList.remove("a-active-highlight"))}),this.currentMatchIndex=t;let e=this.foundMatches[this.currentMatchIndex];void 0!==e.pageNumber&&(this.pdfViewer.goToPage(e.pageNumber),this.waitForPageContainer(e.pageNumber).then(()=>{this.refreshInlineHighlightsForPage(e.pageNumber).then(()=>{var t=document.querySelector(`#pageContainer-${e.pageNumber} .a-text-layer`);t&&((t=t.querySelector(".search-highlight"))&&(t.classList.add("a-active-highlight"),t.scrollIntoView({behavior:"smooth",block:"center"})),this.matchCounterElement)&&(this.matchCounterElement.textContent=this.currentMatchIndex+1+" / "+this.foundMatches.length)})}))}}nextMatch(){var t;0!==this.foundMatches.length&&(t=(this.currentMatchIndex+1)%this.foundMatches.length,this.selectMatch(t))}prevMatch(){var t;0!==this.foundMatches.length&&(t=(this.currentMatchIndex-1+this.foundMatches.length)%this.foundMatches.length,this.selectMatch(t))}createSearchLayout(){var t=document.querySelector(`#${this.pdfState.containerId} .`+aPdfViewerClassNames._A_PDF_VIEWER);if(t){var e=document.createElement("div"),a=(e.classList.add("a-search-container","a-search-hidden"),document.createElement("div")),h=(a.classList.add("a-search-bar"),document.createElement("input")),r=(h.type="text",h.placeholder="Search...",h.classList.add("a-search-input"),h.oninput=e=>__awaiter(this,void 0,void 0,function*(){var t=e.target;yield this.search(t.value,{matchCase:!1,regex:!1,wholeWord:!1})}),this.searchInputElement=h,document.createElement("span")),i=(r.classList.add("a-match-counter"),r.textContent="0/0",this.matchCounterElement=r,document.createElement("div")),s=(i.classList.add("a-separator"),document.createElement("button")),c=(s.classList.add("a-search-nav","up"),s.textContent="▲",s.addEventListener("click",()=>{this.prevMatch()}),this.upButtonElement=s,document.createElement("button"));c.classList.add("a-search-nav","down"),c.textContent="▼",c.addEventListener("click",()=>{this.nextMatch()}),this.downButtonElement=c,a.appendChild(h),a.appendChild(r),a.appendChild(i),a.appendChild(s),a.appendChild(c);let n=document.createElement("div");n.classList.add("a-options-container"),["Match Case","Whole Word","Regex"].forEach(t=>{var e=document.createElement("label"),a=(e.classList.add("a-option-label"),document.createElement("input"));a.type="checkbox",a.classList.add("a-search-option"),a.dataset.option=t.toLowerCase().replace(" ","-"),e.appendChild(a),e.appendChild(document.createTextNode(t)),n.appendChild(e)}),e.appendChild(a),e.appendChild(n),t.appendChild(e)}}}export default PdfSearch;
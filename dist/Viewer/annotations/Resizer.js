import{INNER_PADDING_PX,MIN_SHAPE_SIZE}from"../../constants/geometry-constants";class Resizer{constructor(t,e,i,s){var r,n,a;this._resizers=[],this._isResizing=!1,this._activeResizerIndex=-1,this._isDragging=!1,this._marginLeft=0,this._marginTop=0,this._marginRight=0,this._marginBottom=0,this._origCX=0,this._origCY=0,this._origRX=0,this._origRY=0,this._svg=t,this._element=e,this._onShapeUpdateCallback=i,this._constraints=s,this._kind=e.tagName.toLowerCase(),"rect"===this._kind&&(t=parseFloat(this._svg.getAttribute("width")||"0"),i=parseFloat(this._svg.getAttribute("height")||"0"),s=parseFloat(this._element.getAttribute("x")||"0"),r=parseFloat(this._element.getAttribute("y")||"0"),n=parseFloat(this._element.getAttribute("width")||"0"),a=parseFloat(this._element.getAttribute("height")||"0"),this._marginLeft=s,this._marginTop=r,this._marginRight=t-(s+n),this._marginBottom=i-(r+a)),"ellipse"===this._kind&&(this._origCX=+(t=e).getAttribute("cx"),this._origCY=+t.getAttribute("cy"),this._origRX=+t.getAttribute("rx"),this._origRY=+t.getAttribute("ry"),this._marginLeft=this._marginTop=this._marginRight=this._marginBottom=INNER_PADDING_PX),this._createOverlay(),this._createResizerHandles(),this.syncOverlayToSvg()}set constraintsValue(t){this._constraints=t}syncOverlayToSvg(){var t=parseFloat(this._svg.getAttribute("width")||"0"),e=parseFloat(this._svg.getAttribute("height")||"0"),i=("rect"===this._kind&&(i=parseFloat(this._element.getAttribute("x")||"0"),r=parseFloat(this._element.getAttribute("y")||"0"),s=parseFloat(this._element.getAttribute("width")||"0"),n=parseFloat(this._element.getAttribute("height")||"0"),this._marginLeft=i,this._marginTop=r,this._marginRight=t-(i+s),this._marginBottom=e-(r+n)),parseFloat(this._svg.style.left)||0),s=parseFloat(this._svg.style.top)||0,r=t,n=e;if(this._overlaySvg.style.left=i+"px",this._overlaySvg.style.top=s+"px",this._overlaySvg.setAttribute("width",r.toString()),this._overlaySvg.setAttribute("height",n.toString()),"line"===this._kind){let i=this._element.getAttribute("x1"),s=this._element.getAttribute("y1"),r=this._element.getAttribute("x2"),n=this._element.getAttribute("y2");this._overlayLine.setAttribute("x1",i),this._overlayLine.setAttribute("y1",s),this._overlayLine.setAttribute("x2",r),this._overlayLine.setAttribute("y2",n),void this._resizers.forEach((t,e)=>{t.setAttribute("cx",0===e?i:r),t.setAttribute("cy",0===e?s:n)})}else this._updateOverlayDimensions(i,s,r,n)}removeResizers(){this._overlaySvg&&this._overlaySvg.parentElement&&this._overlaySvg.parentElement.removeChild(this._overlaySvg),this._resizers=[]}_createOverlay(){var t;this._overlaySvg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._overlaySvg.style.position="absolute",this._overlaySvg.style.overflow="visible",this._overlaySvg.style.pointerEvents="none",null!=(t=this._svg.parentElement)&&t.appendChild(this._overlaySvg),"line"===this._kind?(this._overlayLine=document.createElementNS("http://www.w3.org/2000/svg","line"),this._overlayLine.setAttribute("stroke-width",String(parseFloat(this._element.getAttribute("stroke-width")||"1")+10)),this._overlayLine.style.pointerEvents="stroke",this._overlayLine.addEventListener("mousedown",t=>this._onLineDragStart(t)),this._overlaySvg.appendChild(this._overlayLine)):(this._overlayRect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._overlayRect.setAttribute("fill","none"),this._overlayRect.setAttribute("stroke","red"),this._overlayRect.setAttribute("stroke-dasharray","4"),this._overlayRect.style.pointerEvents="fill",this._overlayRect.addEventListener("mousedown",t=>this._onDragStart(t)),this._overlaySvg.appendChild(this._overlayRect))}_createResizerHandles(){if("line"===this._kind)[0,1].forEach(e=>{var t=document.createElementNS("http://www.w3.org/2000/svg","circle");t.setAttribute("r","6"),t.setAttribute("fill","white"),t.setAttribute("stroke","blue"),t.style.cursor="move",t.style.pointerEvents="all",t.dataset.idx=String(e),t.addEventListener("mousedown",t=>this._onLineMouseDown(t,e)),this._overlaySvg.appendChild(t),this._resizers.push(t)});else for(let e=0;e<8;e++){var t=document.createElementNS("http://www.w3.org/2000/svg","circle");t.setAttribute("r","5"),t.setAttribute("fill","blue"),t.setAttribute("stroke","white"),t.setAttribute("stroke-width","1"),t.dataset.index=e.toString(),t.style.cursor=this._cursorForHandle(e),t.style.pointerEvents="all",t.addEventListener("mousedown",t=>this._onHandleMouseDown(t,e)),this._overlaySvg.appendChild(t),this._resizers.push(t)}}_cursorForHandle(t){switch(t){case 0:return"nwse-resize";case 1:return"ns-resize";case 2:return"nesw-resize";case 3:return"ew-resize";case 4:return"nwse-resize";case 5:return"ns-resize";case 6:return"nesw-resize";case 7:return"ew-resize";default:return"default"}}_updateOverlayDimensions(t,e,i,s){this._overlayRect.setAttribute("x","0"),this._overlayRect.setAttribute("y","0"),this._overlayRect.setAttribute("width",i.toString()),this._overlayRect.setAttribute("height",s.toString()),this._updateHandlePositions(i,s)}_updateHandlePositions(t,e){let i=[{x:0,y:0},{x:t/2,y:0},{x:t,y:0},{x:t,y:e/2},{x:t,y:e},{x:t/2,y:e},{x:0,y:e},{x:0,y:e/2}];this._resizers.forEach((t,e)=>{t.setAttribute("cx",i[e].x.toString()),t.setAttribute("cy",i[e].y.toString())})}_onHandleMouseDown(t,i){t.stopPropagation(),t.preventDefault(),this._isResizing=!0,this._activeResizerIndex=i;let s=t.clientX,r=t.clientY,n=parseFloat(this._svg.style.left)||0,a=parseFloat(this._svg.style.top)||0,h=parseFloat(this._svg.getAttribute("width")||"0"),o=parseFloat(this._svg.getAttribute("height")||"0"),e=t=>{var e=t.clientX-s,t=t.clientY-r;this._resizeRect(i,n,a,h,o,e,t),this.syncOverlayToSvg()},l=()=>{var t;this._isResizing=!1,document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",l),null!=(t=this._onShapeUpdateCallback)&&t.call(this)};document.addEventListener("mousemove",e),document.addEventListener("mouseup",l)}_onLineMouseDown(t,l){t.stopPropagation(),t.preventDefault(),this._isResizing=!0,this._activeResizerIndex=l;t.target;let _=t.clientX,g=t.clientY;var t=parseFloat(this._element.getAttribute("x1")),e=parseFloat(this._element.getAttribute("y1")),i=parseFloat(this._element.getAttribute("x2")),s=parseFloat(this._element.getAttribute("y2")),r=parseFloat(this._svg.style.left)||0,n=parseFloat(this._svg.style.top)||0;let u={x:r+t,y:n+e},m={x:r+i,y:n+s},a=t=>{var e=t.clientX-_,t=t.clientY-g,i=0===l?{x:u.x+e,y:u.y+t}:Object.assign({},u),e=1===l?{x:m.x+e,y:m.y+t}:Object.assign({},m),t=(this._constraints&&({width:t,height:s}=this._constraints,i.x=Math.min(Math.max(i.x,0),t),i.y=Math.min(Math.max(i.y,0),s),e.x=Math.min(Math.max(e.x,0),t),e.y=Math.min(Math.max(e.y,0),s)),e.x-i.x),s=e.y-i.y,t=Math.abs(t),s=Math.abs(s),r=Math.max(t,s,MIN_SHAPE_SIZE),t=(r-t)/2,s=(r-s)/2,t=Math.min(i.x,e.x)-t,s=Math.min(i.y,e.y)-s;this._svg.style.left=t+"px",this._svg.style.top=s+"px",this._svg.setAttribute("width",""+r),this._svg.setAttribute("height",""+r);const n=i.x-t,a=i.y-s,h=e.x-t,o=e.y-s;this._element.setAttribute("x1",""+n),this._element.setAttribute("y1",""+a),this._element.setAttribute("x2",""+h),this._element.setAttribute("y2",""+o);r=this._element.nextElementSibling;r&&"transparent"===r.getAttribute("stroke")&&(r.setAttribute("x1",""+n),r.setAttribute("y1",""+a),r.setAttribute("x2",""+h),r.setAttribute("y2",""+o)),this.syncOverlayToSvg()},h=t=>{this._isResizing=!1,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",h),this._onShapeUpdateCallback()};document.addEventListener("mousemove",a),document.addEventListener("mouseup",h)}_onLineDragStart(i){if(!this._isResizing){i.stopPropagation(),i.preventDefault(),this._isDragging=!0;let r=i.clientX,n=i.clientY,a=parseFloat(this._svg.style.left)||0,h=parseFloat(this._svg.style.top)||0,o=parseFloat(this._svg.getAttribute("width")||"0"),l=parseFloat(this._svg.getAttribute("height")||"0");var i=parseFloat(this._element.getAttribute("x1")),s=parseFloat(this._element.getAttribute("y1")),u=parseFloat(this._element.getAttribute("x2")),m=parseFloat(this._element.getAttribute("y2"));let _={x:a+i,y:h+s},g={x:a+u,y:h+m},t=t=>{var e=t.clientX-r,t=t.clientY-n,i=Math.max(-_.x,-g.x),s=Math.min(this._constraints.width-_.x,this._constraints.width-g.x),e=Math.min(Math.max(e,i),s),i=Math.max(-_.y,-g.y),s=Math.min(this._constraints.height-_.y,this._constraints.height-g.y),t=Math.min(Math.max(t,i),s),i=a+e,s=h+t;this._updateSvgAndRect(i,s,o,l),this.syncOverlayToSvg()},e=()=>{this._isDragging=!1,document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",e),this._onShapeUpdateCallback()};document.addEventListener("mousemove",t),document.addEventListener("mouseup",e)}}_onDragStart(t){if(!this._isResizing){t.stopPropagation(),t.preventDefault(),this._isDragging=!0;let r=t.clientX,n=t.clientY,a=parseFloat(this._svg.style.left)||0,h=parseFloat(this._svg.style.top)||0,o=parseFloat(this._svg.getAttribute("width")||"0"),l=parseFloat(this._svg.getAttribute("height")||"0"),e=t=>{var e=t.clientX-r,t=t.clientY-n;let i=a+e,s=h+t;this._constraints&&"line"!==this._kind&&(i+this._marginLeft<0&&(i=-this._marginLeft),s+this._marginTop<0&&(s=-this._marginTop),i+o-this._marginRight>this._constraints.width&&(i=this._constraints.width-(o-this._marginRight)),s+l-this._marginBottom>this._constraints.height)&&(s=this._constraints.height-(l-this._marginBottom)),this._updateSvgAndRect(i,s,o,l),this.syncOverlayToSvg()},i=()=>{var t;this._isDragging=!1,null!=(t=this._onShapeUpdateCallback)&&t.call(this),document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",e),document.addEventListener("mouseup",i)}}_resizeRect(t,e,i,s,r,n,a){let h=e,o=i,l=s,_=r;switch(t){case 0:h=e+n,o=i+a,l=s-n,_=r-a;break;case 1:o=i+a,_=r-a;break;case 2:o=i+a,l=s+n,_=r-a;break;case 3:l=s+n;break;case 4:l=s+n,_=r+a;break;case 5:_=r+a;break;case 6:h=e+n,l=s-n,_=r+a;break;case 7:h=e+n,l=s-n}l<MIN_SHAPE_SIZE&&(l=MIN_SHAPE_SIZE,[0,6,7].includes(t))&&(h=e+(s-MIN_SHAPE_SIZE)),_<MIN_SHAPE_SIZE&&(_=MIN_SHAPE_SIZE,[0,1,2].includes(t))&&(o=i+(r-MIN_SHAPE_SIZE)),h+this._marginLeft<0&&(t=-(h+this._marginLeft),h+=t,l-=t),o+this._marginTop<0&&(t=-(o+this._marginTop),o+=t,_-=t),this._constraints&&(h+l-this._marginRight>this._constraints.width&&(l=this._constraints.width-h+this._marginRight),o+_-this._marginBottom>this._constraints.height)&&(_=this._constraints.height-o+this._marginBottom),this._updateSvgAndRect(h,o,l,_),"ellipse"===this._kind&&this._updateEllipse(l,_)}_updateEllipse(t,e){var i,s=MIN_SHAPE_SIZE/2,t=Math.max((t-2*INNER_PADDING_PX)/2,s),e=Math.max((e-2*INNER_PADDING_PX)/2,s),s=t+INNER_PADDING_PX,r=e+INNER_PADDING_PX,n=this._element;n.setAttribute("cx",""+s),n.setAttribute("cy",""+r),n.setAttribute("rx",""+t),n.setAttribute("ry",""+e),null!=(i=n.nextElementSibling)&&i.setAttribute("cx",""+s),null!=(i=n.nextElementSibling)&&i.setAttribute("cy",""+r),null!=(s=n.nextElementSibling)&&s.setAttribute("rx",""+t),null!=(i=n.nextElementSibling)&&i.setAttribute("ry",""+e)}_updateSvgAndRect(t,e,i,s){var r;this._svg.style.left=t+"px",this._svg.style.top=e+"px",this._svg.setAttribute("width",i.toString()),this._svg.setAttribute("height",s.toString()),"rect"===this._kind&&(t=this._marginLeft,e=this._marginTop,i=i-this._marginLeft-this._marginRight,s=s-this._marginTop-this._marginBottom,this._element.setAttribute("x",t.toString()),this._element.setAttribute("y",e.toString()),this._element.setAttribute("width",i.toString()),this._element.setAttribute("height",s.toString()),null!=(r=this._element.nextElementSibling)&&r.setAttribute("x",t.toString()),null!=(r=this._element.nextElementSibling)&&r.setAttribute("y",e.toString()),null!=(t=this._element.nextElementSibling)&&t.setAttribute("width",i.toString()),null!=(r=this._element.nextElementSibling))&&r.setAttribute("height",s.toString())}}export{Resizer};
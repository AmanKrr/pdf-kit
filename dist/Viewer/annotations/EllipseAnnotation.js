import{INNER_PADDING_PX}from"../../constants/geometry-constants";import{Annotation}from"./Annotation";import{Resizer}from"./Resizer";class EllipseAnnotation extends Annotation{get id(){return this.annotationId}constructor(t,e,i,s,_,h,r,n){super(t,e,n),this.type="ellipse",this._resizer=null,this._origCX=0,this._origCY=0,this._origRX=0,this._origRY=0,this._shapeInfo=null,this._onDeleteKeyBound=this._onDeleteKey.bind(this),this._bindOnScaleChange=this._onScaleChange.bind(this),this._pdfState=e,this._fillColor=i,this._strokeColor=s,this._strokeWidth=_,this._strokeStyle=h,this._opacity=r,this._constraints=t.getBoundingClientRect(),e.on("scaleChange",this._bindOnScaleChange)}_onScaleChange(t){this._constraints=this.__annotationDrawerContainer.getBoundingClientRect(),this._updateZoom(this._pdfState.scale)}draw(t,e,i,s,_){var h=INNER_PADDING_PX,t=t-i-h,e=e-s-h,r=2*i+2*h,n=2*s+2*h;this.isDrawing=!1,this.__svg.style.left=t+"px",this.__svg.style.top=e+"px",this.__svg.setAttribute("width",""+r),this.__svg.setAttribute("height",""+n),this._pageNumber=_,this.createSvgEllipse(i+h,s+h,i,s),this._captureOriginal(1),this._updateZoom(null==(t=this.__pdfState)?void 0:t.scale),this._setEllipseInfo()}startDrawing(t,e,i){super.startDrawing(t,e,i),this.__svg.style.left=t+"px",this.__svg.style.top=e+"px",this.createSvgEllipse(),this._pageNumber=i}updateDrawing(t,e){var i,s;this.isDrawing&&this.__element&&(t=t-this.__startX,e=e-this.__startY,i=Math.min(this.__startX,this.__startX+t)-INNER_PADDING_PX,s=Math.min(this.__startY,this.__startY+e)-INNER_PADDING_PX,t=Math.abs(t),e=Math.abs(e),this.__svg.style.left=i+"px",this.__svg.style.top=s+"px",this.__svg.setAttribute("width",""+(t+2*INNER_PADDING_PX)),this.__svg.setAttribute("height",""+(e+2*INNER_PADDING_PX)),s=INNER_PADDING_PX+(i=e/2),this.__element.setAttribute("cx",""+(t=INNER_PADDING_PX+(e=t/2))),this.__element.setAttribute("cy",""+s),this.__element.setAttribute("rx",""+e),this.__element.setAttribute("ry",""+i),this.__hitElementRect.setAttribute("cx",""+t),this.__hitElementRect.setAttribute("cy",""+s),this.__hitElementRect.setAttribute("rx",""+e),this.__hitElementRect.setAttribute("ry",""+i))}stopDrawing(t={select:!0,shapeUpdate:!0}){super.stopDrawing(),this._captureOriginal(),this._setEllipseInfo(),t.select&&this.select(),t.shapeUpdate&&this._onShapeUpdate()}select(){this._resizer||(this._resizer=new Resizer(this.__svg,this.__element,this._onShapeUpdate.bind(this),this._constraints),this.__svg.focus(),this.__svg.addEventListener("keydown",this._onDeleteKeyBound))}deselect(){this._resizer&&(this.__svg.removeEventListener("keydown",this._onDeleteKeyBound),this._resizer.removeResizers(),this._resizer=null)}deleteAnnotation(t=!1){this.__svg&&(this.deselect(),this.__svg.remove(),t||null!=(t=this.__pdfState)&&t.emit("ANNOTATION_DELETED",this.id))}revokeSelection(){this.__hitElementRect&&(this.__hitElementRect.style.cursor="default",this.__hitElementRect.onclick=null)}scrollToView(){var t;null!=(t=this.__svg)&&t.scrollIntoView({block:"center"})}getConfig(){var t;return null!=(t=this._shapeInfo)?t:{}}createSvgEllipse(t=0,e=0,i=0,s=0){this.__element=document.createElementNS("http://www.w3.org/2000/svg","ellipse"),this.__element.id=this.annotationId,this.__element.setAttribute("cx",""+t),this.__element.setAttribute("cy",""+e),this.__element.setAttribute("rx",""+i),this.__element.setAttribute("ry",""+s),this.__element.setAttribute("fill",this._fillColor),this.__element.setAttribute("stroke",this._strokeColor),this.__element.setAttribute("stroke-width",""+this._strokeWidth),this.__element.setAttribute("stroke-dasharray",this._getStrokeDashArray()),this.__element.setAttribute("opacity",this._opacity.toString()),this.__svg.appendChild(this.__element),this.__hitElementRect=document.createElementNS("http://www.w3.org/2000/svg","ellipse"),this.__hitElementRect.setAttribute("cx",""+t),this.__hitElementRect.setAttribute("cy",""+e),this.__hitElementRect.setAttribute("rx",""+i),this.__hitElementRect.setAttribute("ry",""+s),this.__hitElementRect.setAttribute("fill","none"),this.__hitElementRect.setAttribute("stroke","transparent"),this.__hitElementRect.style.strokeWidth=""+(this._strokeWidth+10),this.__hitElementRect.style.cursor="pointer",this.__hitElementRect.style.pointerEvents="auto",this.__hitElementRect.onclick=t=>{t.stopPropagation(),t.preventDefault(),this.__onAnnotationClick(t,this.getConfig())},this.__svg.appendChild(this.__hitElementRect)}_onDeleteKey(t){"Delete"!==t.key&&"Backspace"!==t.key||this.deleteAnnotation()}_captureOriginal(t=0){var t=t||(null==(t=this.__pdfState)?void 0:t.scale)||1,e=this.__svg.getBBox(),i=parseFloat(this.__svg.style.left)/t,s=parseFloat(this.__svg.style.top)/t;this._origRX=e.width/2/t,this._origRY=e.height/2/t,this._origCX=i+this._origRX+10,this._origCY=s+this._origRY+10}_updateZoom(t){var e=this._origCX*t,i=this._origCY*t,s=this._origRX*t,t=this._origRY*t,_=INNER_PADDING_PX,e=(this.__svg.style.left=e-s-_+"px",this.__svg.style.top=i-t-_+"px",this.__svg.setAttribute("width",""+(2*s+2*_)),this.__svg.setAttribute("height",""+(2*t+2*_)),this.__element),i=this.__hitElementRect;e.setAttribute("cx",""+(_+s)),e.setAttribute("cy",""+(_+t)),e.setAttribute("rx",""+s),e.setAttribute("ry",""+t),i.setAttribute("cx",""+(_+s)),i.setAttribute("cy",""+(_+t)),i.setAttribute("rx",""+s),i.setAttribute("ry",""+t),this._resizer&&(this._resizer.constraintsValue=this._constraints,this._resizer.syncOverlayToSvg())}_getStrokeDashArray(){return"dashed"===this._strokeStyle?"5,5":"dotted"===this._strokeStyle?"2,2":"0"}_logicalCoords(){var t,e,i,s=(null==(s=this.__pdfState)?void 0:s.scale)||1;return this._origRX?{cx:this._origCX,cy:this._origCY,rx:this._origRX,ry:this._origRY}:(t=this.__svg.getBBox(),e=parseFloat(this.__svg.style.left)/s,i=parseFloat(this.__svg.style.top)/s,{cx:e+(e=t.width/2/s)+10,cy:i+(i=t.height/2/s)+10,rx:e,ry:i})}_setEllipseInfo(){var{cx:t,cy:e,rx:i,ry:s}=this._logicalCoords();this._shapeInfo={id:this.annotationId,pageNumber:this._pageNumber,cx:t,cy:e,rx:i,ry:s,fillColor:this._fillColor,strokeColor:this._strokeColor,strokeWidth:this._strokeWidth,strokeStyle:this._strokeStyle,opacity:this._opacity,type:"ellipse"}}_onShapeUpdate(){var t;this._captureOriginal(),this._setEllipseInfo(),null!=(t=this.__pdfState)&&t.emit("ANNOTATION_CREATED",this.getConfig())}}export{EllipseAnnotation};
import{INNER_PADDING_PX}from"../../constants/geometry-constants";import{Annotation}from"./Annotation";import{Resizer}from"./Resizer";class LineAnnotation extends Annotation{get id(){return this.annotationId}constructor(t,e,i,s,r,n,o){super(t,e,o),this.type="line",this._resizer=null,this._origX1=0,this._origY1=0,this._origX2=0,this._origY2=0,this._shapeInfo=null,this._onDeleteKeyBound=this._onDeleteKey.bind(this),this._bindOnScaleChange=this._onScaleChange.bind(this),this._pdfState=e,this._strokeColor=i,this._strokeWidth=s,this._strokeStyle=r,this._opacity=n,this._constraints=t.getBoundingClientRect(),e.on("scaleChange",this._bindOnScaleChange)}_onScaleChange(t){this._constraints=this.__annotationDrawerContainer.getBoundingClientRect(),this._updateZoom(this._pdfState.scale)}draw(t,e,i,s,r){var n=INNER_PADDING_PX,o=Math.min(t,i),h=Math.min(e,s),_=Math.abs(i-t),a=Math.abs(s-e);this.isDrawing=!1,this.__svg.style.left=o-n+"px",this.__svg.style.top=h-n+"px",this.__svg.setAttribute("width",""+(_+2*n)),this.__svg.setAttribute("height",""+(a+2*n)),this._pageNumber=r,this.createSvgLine(t-o+n,e-h+n,i-o+n,s-h+n),this._captureOriginal(),this._updateZoom(this._pdfState.scale),this._setLineInfo()}startDrawing(t,e,i){super.startDrawing(t,e,i),this.__svg.style.left=t+"px",this.__svg.style.top=e+"px",this.createSvgLine(),this._pageNumber=i}updateDrawing(t,e){var i,s,r,n,o;this.isDrawing&&this.__element&&(o=INNER_PADDING_PX,t=t-this.__startX,e=e-this.__startY,s=Math.min(this.__startX,this.__startX+t),r=Math.min(this.__startY,this.__startY+e),i=Math.abs(t),n=Math.abs(e),this.__svg.style.left=s-o+"px",this.__svg.style.top=r-o+"px",this.__svg.setAttribute("width",""+(i+2*o)),this.__svg.setAttribute("height",""+(n+2*o)),s=0<=e?o:o+n,r=0<=t?o+i:o,e=0<=e?o+n:o,(n=this.__element).setAttribute("x1",(t=0<=t?o:o+i).toString()),n.setAttribute("y1",s.toString()),n.setAttribute("x2",r.toString()),n.setAttribute("y2",e.toString()),(o=this.__hitElementRect).setAttribute("x1",t.toString()),o.setAttribute("y1",s.toString()),o.setAttribute("x2",r.toString()),o.setAttribute("y2",e.toString()))}stopDrawing(t={select:!0,shapeUpdate:!0}){super.stopDrawing(),this._captureOriginal(),this._setLineInfo(),t.select&&this.select(),t.shapeUpdate&&this._onShapeUpdate()}select(){this._resizer||(this._resizer=new Resizer(this.__svg,this.__element,this._onShapeUpdate.bind(this),this.__annotationDrawerContainer.getBoundingClientRect()),this.__svg.focus(),this.__svg.addEventListener("keydown",this._onDeleteKeyBound))}deselect(){this._resizer&&(this.__svg.removeEventListener("keydown",this._onDeleteKeyBound),this._resizer.removeResizers(),this._resizer=null)}deleteAnnotation(t=!1){this.deselect(),this.__svg.remove(),t||this._pdfState.emit("ANNOTATION_DELETED",this.id)}revokeSelection(){this.__hitElementRect&&(this.__hitElementRect.style.cursor="default",this.__hitElementRect.onclick=null)}scrollToView(){this.__svg.scrollIntoView({block:"center"})}getConfig(){var t;return null!=(t=this._shapeInfo)?t:{}}createSvgLine(t=0,e=0,i=0,s=0){this.__element=document.createElementNS("http://www.w3.org/2000/svg","line"),this.__element.id=this.annotationId;var r=this.__element,r=(r.setAttribute("x1",t.toString()),r.setAttribute("y1",e.toString()),r.setAttribute("x2",i.toString()),r.setAttribute("y2",s.toString()),r.setAttribute("stroke",this._strokeColor),r.setAttribute("stroke-width",this._strokeWidth.toString()),r.setAttribute("opacity",this._opacity.toString()),"dashed"===this._strokeStyle?r.setAttribute("stroke-dasharray","5,5"):"dotted"===this._strokeStyle&&r.setAttribute("stroke-dasharray","2,2"),r.setAttribute("vector-effect","non-scaling-stroke"),this.__svg.appendChild(r),this.__hitElementRect=document.createElementNS("http://www.w3.org/2000/svg","line"),this.__hitElementRect);r.setAttribute("x1",t.toString()),r.setAttribute("y1",e.toString()),r.setAttribute("x2",i.toString()),r.setAttribute("y2",s.toString()),r.setAttribute("stroke","transparent"),r.style.strokeWidth=""+(this._strokeWidth+10),r.style.cursor="pointer",r.style.pointerEvents="auto",r.onclick=t=>{t.stopPropagation(),t.preventDefault(),this.__onAnnotationClick(t,this.getConfig())},this.__svg.appendChild(r)}_onDeleteKey(t){"Delete"!==t.key&&"Backspace"!==t.key||this.deleteAnnotation()}_captureOriginal(){var{x1:t,y1:e,x2:i,y2:s}=this._logicalCoords();this._origX1=t,this._origY1=e,this._origX2=i,this._origY2=s}_updateZoom(t){var e,i,s,r,n,o,h,_;this.__element&&(e=INNER_PADDING_PX*t,i=this._origX1*t,o=this._origY1*t,h=this._origX2*t,t=this._origY2*t,s=Math.min(i,h),_=Math.min(o,t),r=Math.abs(h-i),n=Math.abs(t-o),this.__svg.style.left=s-e+"px",this.__svg.style.top=_-e+"px",this.__svg.setAttribute("width",""+(r+2*e)),this.__svg.setAttribute("height",""+(n+2*e)),r=o-_+e,n=h-s+e,o=t-_+e,(h=this.__element).setAttribute("x1",(t=i-s+e).toString()),h.setAttribute("y1",r.toString()),h.setAttribute("x2",n.toString()),h.setAttribute("y2",o.toString()),(_=this.__hitElementRect).setAttribute("x1",t.toString()),_.setAttribute("y1",r.toString()),_.setAttribute("x2",n.toString()),_.setAttribute("y2",o.toString()),this._resizer)&&(this._resizer.constraintsValue=this._constraints,this._resizer.syncOverlayToSvg())}_logicalCoords(){var t=this._pdfState.scale||1,e=parseFloat(this.__svg.style.left)/t,i=parseFloat(this.__svg.style.top)/t,s=this.__element;return{x1:e+parseFloat(s.getAttribute("x1"))/t,y1:i+parseFloat(s.getAttribute("y1"))/t,x2:e+parseFloat(s.getAttribute("x2"))/t,y2:i+parseFloat(s.getAttribute("y2"))/t}}_setLineInfo(){var{x1:t,y1:e,x2:i,y2:s}=this._logicalCoords();this._shapeInfo={id:this.annotationId,pageNumber:this._pageNumber,x1:t,y1:e,x2:i,y2:s,strokeColor:this._strokeColor,strokeWidth:this._strokeWidth,strokeStyle:this._strokeStyle,opacity:this._opacity,type:"line"}}_onShapeUpdate(){this._captureOriginal(),this._setLineInfo(),this._pdfState.emit("ANNOTATION_CREATED",this.getConfig())}}export{LineAnnotation};
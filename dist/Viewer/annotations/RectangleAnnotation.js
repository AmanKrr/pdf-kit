import{INNER_PADDING_PX}from"../../constants/geometry-constants";import{Annotation}from"./Annotation";import{Resizer}from"./Resizer";class RectangleAnnotation extends Annotation{get id(){return this.annotationId}constructor(t,e,i,s,_,h,n,r){super(t,e,r),this._resizer=null,this._originalLeft=0,this._originalTop=0,this._originalWidth=0,this._originalHeight=0,this._shapeInfo=null,this._onDeleteKeyBound=this._onDeleteKey.bind(this),this._bindOnScaleChange=this._onScaleChange.bind(this),this.type="rectangle",this._pdfState=e,this._constraints=t.getBoundingClientRect(),this._fillColor=i,this._strokeColor=s,this._strokeWidth=_,this._strokeStyle=h,this._opacity=n,e.on("scaleChange",this._bindOnScaleChange)}_onScaleChange(t){this._constraints=this.__annotationDrawerContainer.getBoundingClientRect(),this._updateZoom(this._pdfState.scale)}draw(t,e,i,s,_){this.__startX=t,this.__startY=i,this.isDrawing=!1,this.__svg.style.left=t+"px",this.__svg.style.top=i+"px",this.__svg.setAttribute("width",""+(e+2*INNER_PADDING_PX)),this.__svg.setAttribute("height",""+(s+2*INNER_PADDING_PX)),this._pageNumber=_,this._createSvgRect(INNER_PADDING_PX.toString(),s,e),this._maintainOriginalBounding(1),this._updateZoom(this.__pdfState.scale),this._setRectInfo()}startDrawing(t,e,i){super.startDrawing(t,e,i),this.__svg.style.left=t+"px",this.__svg.style.top=e+"px",this._createSvgRect(),this._pageNumber=i}updateDrawing(t,e){var i,s;this.isDrawing&&this.__element&&this.__hitElementRect&&(i=this._constraints.width-INNER_PADDING_PX,s=this._constraints.height-INNER_PADDING_PX,t=Math.min(Math.max(t,0),i),i=Math.min(Math.max(e,0),s),e=t-this.__startX,s=i-this.__startY,this.__svg.setAttribute("width",""+(Math.abs(e)+2*INNER_PADDING_PX)),this.__svg.setAttribute("height",""+(Math.abs(s)+2*INNER_PADDING_PX)),this.__element.setAttribute("x",""+INNER_PADDING_PX),this.__element.setAttribute("y",""+INNER_PADDING_PX),this.__element.setAttribute("width",""+Math.abs(e)),this.__element.setAttribute("height",""+Math.abs(s)),this.__hitElementRect.setAttribute("x",""+INNER_PADDING_PX),this.__hitElementRect.setAttribute("y",""+INNER_PADDING_PX),this.__hitElementRect.setAttribute("width",""+Math.abs(e)),this.__hitElementRect.setAttribute("height",""+Math.abs(s)),e<0&&(this.__svg.style.left=t-INNER_PADDING_PX+"px"),s<0)&&(this.__svg.style.top=i-INNER_PADDING_PX+"px")}stopDrawing(t={select:!0,shapeUpdate:!0}){super.stopDrawing(),this._maintainOriginalBounding(),this._setRectInfo(),t.select&&this.select(),t.shapeUpdate&&this._onShapeUpdate()}select(){this._resizer||(this._resizer=new Resizer(this.__svg,this.__element,this._onShapeUpdate.bind(this),this._constraints),this.__svg.focus(),this._addDeleteEvent())}deselect(){this._resizer&&(this._removeDeleteEvent(),this._resizer.removeResizers(),this._resizer=null)}deleteAnnotation(t=!1){this.__svg&&(this._resizer&&(this._removeDeleteEvent(),this._resizer.removeResizers(),this._resizer=null),this.__svg.remove()),t||null!=(t=this.__pdfState)&&t.emit("ANNOTATION_DELETED",this.id)}revokeSelection(){this.__hitElementRect&&(this.__hitElementRect.style.cursor="default",this.__hitElementRect.onclick=null)}scrollToView(){var t;null!=(t=this.__svg)&&t.scrollIntoView({block:"center"})}getConfig(){var t;return null!=(t=this._shapeInfo)?t:{}}_createSvgRect(t="0",e=0,i=0){this.__element=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.__element.id=this.annotationId,this.__element.setAttribute("x",t),this.__element.setAttribute("y",t),this.__element.setAttribute("width",Math.abs(i).toString()),this.__element.setAttribute("height",Math.abs(e).toString()),this.__element.setAttribute("fill",this._fillColor),this.__element.setAttribute("stroke",this._strokeColor),this.__element.setAttribute("stroke-width",this._strokeWidth.toString()),this.__element.setAttribute("stroke-dasharray",this._getStrokeDashArray()),this.__element.setAttribute("opacity",this._opacity.toString()),this.__svg.appendChild(this.__element),this.__hitElementRect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.__hitElementRect.setAttribute("x",t),this.__hitElementRect.setAttribute("y",t),this.__hitElementRect.setAttribute("width",Math.abs(i).toString()),this.__hitElementRect.setAttribute("height",Math.abs(e).toString()),this.__hitElementRect.setAttribute("fill","none"),this.__hitElementRect.setAttribute("stroke","transparent"),this.__hitElementRect.style.strokeWidth=(this._strokeWidth+10).toString(),this.__hitElementRect.style.cursor="pointer",this.__hitElementRect.style.pointerEvents="auto",this.__hitElementRect.onclick=t=>{t.stopPropagation(),t.preventDefault(),this.__onAnnotationClick(t,this.getConfig())},this.__svg.appendChild(this.__hitElementRect)}_addDeleteEvent(){this.__svg.addEventListener("keydown",this._onDeleteKeyBound)}_removeDeleteEvent(){this.__svg.removeEventListener("keydown",this._onDeleteKeyBound)}_onDeleteKey(t){"Delete"!==t.key&&"Backspace"!==t.key||this.deleteAnnotation()}_maintainOriginalBounding(t=0){t=t||(null==(t=this.__pdfState)?void 0:t.scale)||1;this._originalLeft=(parseFloat(this.__svg.style.left)||0)/t,this._originalTop=(parseFloat(this.__svg.style.top)||0)/t,this._originalWidth=parseFloat(this.__svg.getAttribute("width")||"0")/t,this._originalHeight=parseFloat(this.__svg.getAttribute("height")||"0")/t}_updateZoom(t){var e=this._originalLeft*t,i=this._originalTop*t,s=this._originalWidth*t,_=this._originalHeight*t;this.__svg.style.left=e+"px",this.__svg.style.top=i+"px",this.__svg.setAttribute("width",""+s),this.__svg.setAttribute("height",""+_),this.__element&&(this.__element.setAttribute("x",""+(e=INNER_PADDING_PX*t)),this.__element.setAttribute("y",""+e),this.__element.setAttribute("width",""+(s-2*e)),this.__element.setAttribute("height",""+(_-2*e))),this.__hitElementRect&&(this.__hitElementRect.setAttribute("x",""+(i=INNER_PADDING_PX*t)),this.__hitElementRect.setAttribute("y",""+i),this.__hitElementRect.setAttribute("width",""+(s-2*i)),this.__hitElementRect.setAttribute("height",""+(_-2*i))),this._resizer&&(this._resizer.constraintsValue=this._constraints,this._resizer.syncOverlayToSvg())}_getStrokeDashArray(){return"dashed"===this._strokeStyle?"5,5":"dotted"===this._strokeStyle?"2,2":"0"}_getCoordinates(){var t=this.__svg.getBBox();return{x0:parseFloat(this.__svg.style.left),y0:parseFloat(this.__svg.style.top),x1:t.width,y1:t.height}}_getLogicalCoordinates(){var t,e=(null==(e=this.__pdfState)?void 0:e.scale)||1;return this._originalWidth?{x0:this._originalLeft,y0:this._originalTop,x1:this._originalWidth,y1:this._originalHeight}:(t=this.__svg.getBBox(),{x0:parseFloat(this.__svg.style.left)/e,y0:parseFloat(this.__svg.style.top)/e,x1:t.width/e,y1:t.height/e})}_setRectInfo(){var{x0:t,y0:e,x1:i,y1:s}=this._getLogicalCoordinates();this._shapeInfo={id:this.annotationId,pageNumber:this._pageNumber,x0:t,y0:e,x1:i,y1:s,fillColor:this._fillColor,strokeColor:this._strokeColor,strokeWidth:this._strokeWidth,strokeStyle:this._strokeStyle,opacity:this._opacity,type:"rectangle"}}_onShapeUpdate(){var t;this._maintainOriginalBounding(),this._setRectInfo(),null!=(t=this.__pdfState)&&t.emit("ANNOTATION_CREATED",this.getConfig())}}export{RectangleAnnotation};
import{PDF_VIEWER_CLASSNAMES,PDF_VIEWER_IDS}from"../../constants/pdf-viewer-selectors";class AnnotationToolbar{constructor(e,t){this._color="red",this._fillColor="transparent",this._opacity=1,this._thickness=2,this._borderStyle="Solid",this._shapeOptions={rectangle:"Rectangle",circle:"Ellipse",pen_size_1:"Line"},this._selectedShape="none",this._selectedShapeIcon="none",this._isShapeDropdownOpen=!1,this._isToolbarPropertiesContainerOpen=!1,this._onAnnotationCreated=this._handleAnnotationCreated.bind(this),this._activeAnnotation=null,this._viewer=e,this._pdfState=t,this._pdfState.on("ANNOTATION_CREATED",this._onAnnotationCreated)}_handleAnnotationCreated(e){this._removeToolbarPropertiesContainer(),this._shapeDropdown&&(this._shapeDropdown.style.display="none"),this._isShapeDropdownOpen=!1;var t=null==(t=this._toolbarContainer)?void 0:t.querySelector(`.${PDF_VIEWER_CLASSNAMES.A_ANNOTATION_SHAPE_BUTTON}.active`);null!=t&&t.classList.remove("active"),this.toogleAnnotationDrawing()}toogleAnnotationDrawing(){for(var e of this._viewer.visiblePageNumbers){var t=`#${this._pdfState.containerId} #pageContainer-${e} #`+PDF_VIEWER_IDS.ANNOTATION_DRAWING_LAYER,t=document.querySelector(t);t&&(this._isToolbarPropertiesContainerOpen?(this._initAnnotationListners(!0,e),t.style.cursor="crosshair",t.style.pointerEvents="all"):(this._initAnnotationListners(!1,e),t.style.removeProperty("cursor"),t.style.removeProperty("pointer-events")))}}_initAnnotationListners(e,t){"none"!==this._selectedShape&&(t=this._viewer.annotation.isAnnotationManagerRegistered(t))&&(e?t._initAnnotation():t._initAnnotationCleanup())}updateDrawConfig(){for(var e of this._viewer.visiblePageNumbers){e=this._viewer.annotation.isAnnotationManagerRegistered(e);e&&(e.drawConfig={strokeStyle:this._borderStyle,strokeColor:this._color,fillColor:this._fillColor,opacity:this._opacity,strokeWidth:this._thickness,type:this._selectedShape.toLowerCase()})}}render(){this._toolbarContainer=document.createElement("div"),this._toolbarContainer.classList.add(PDF_VIEWER_CLASSNAMES.A_ANNOTATON_TOOLBAR_CONTAINER,PDF_VIEWER_CLASSNAMES.A_TOOLBAR_ITEMS),this._createGoBackButton();var e=document.createElement("div"),t=(e.classList.add("a-annotation-toolbar-right-container"),e.style.display="flex",e.style.alignItems="center",this._toolbarContainer.appendChild(e),document.createElement("div")),e=(t.style.position="relative",e.appendChild(t),document.createElement("div"));e.classList.add(PDF_VIEWER_CLASSNAMES.A_ANNOTATION_SHAPE_BUTTON),t.appendChild(e);let n=this.createToolbarButton({id:"annotationShape",iconClass:"annotation-shape-icon material-symbols-outlined",tooltip:"Shape",onClick:()=>{}}),o=(n.onclick=()=>{var e;"none"!==this._selectedShape&&(this._isToolbarPropertiesContainerOpen=!this._isToolbarPropertiesContainerOpen,this._pdfState.isAnnotationConfigurationPropertiesEnabled=this._isToolbarPropertiesContainerOpen,null!=(e=n.parentElement)&&e.classList.toggle("active"),this._isToolbarPropertiesContainerOpen?(this._createToolbarPropertiesContainer(),this._injectToolbarContainers(!0,!0),this._toolbarPropertiesContainer.style.removeProperty("display")):(this._removeToolbarPropertiesContainer(),this._shapeDropdown.style.display="none",this._isShapeDropdownOpen=!1),this.toogleAnnotationDrawing(),this.updateDrawConfig())},"none"!==this._selectedShape&&(n.firstChild.textContent=this._selectedShapeIcon),document.createElement("button"));o.classList.add(PDF_VIEWER_CLASSNAMES.A_ANNOTATION_SHAPE_ARROWDOWN),o.innerHTML='<span class="material-symbols-outlined">arrow_drop_down</span>',o.onclick=()=>this._toggleShapeDropdown(o),e.append(n,o),this._shapeDropdown=document.createElement("div"),this._shapeDropdown.classList.add(PDF_VIEWER_CLASSNAMES.A_ANNOTATION_SHAPE_DROPDOWN);for(let[t,o]of Object.entries(this._shapeOptions)){var i=document.createElement("div");i.style.padding="5px",i.style.cursor="pointer",i.onclick=()=>{var e;this._isToolbarPropertiesContainerOpen=!0,this._pdfState.isAnnotationConfigurationPropertiesEnabled=!0,null!=(e=n.parentElement)&&e.classList.add("active"),this._toolbarPropertiesContainer||(this._createToolbarPropertiesContainer(),this._injectToolbarContainers(!0,!0),this._toolbarPropertiesContainer.style.removeProperty("display")),this._selectShape(t,o),n.firstChild.textContent=t,this.toogleAnnotationDrawing()},i.innerHTML=`<span class="material-symbols-outlined">${t}</span><span>${o}</span>`,this._shapeDropdown.appendChild(i)}this._createToolbarPropertiesContainer(),this._injectToolbarContainers(!0,!0)}_injectToolbarContainers(e,t){var o=document.querySelector(`#${this._pdfState.containerId} .${PDF_VIEWER_CLASSNAMES.A_PDF_VIEWER} .`+PDF_VIEWER_CLASSNAMES.A_VIEWER_WRAPPER),n=null==o?void 0:o.parentElement;o&&n&&(e&&n.insertBefore(this._toolbarContainer,o),t)&&n.insertBefore(this._toolbarPropertiesContainer,o)}_removeToolbarContainer(){var e;null!=(e=this._toolbarContainer)&&e.remove(),this._toolbarContainer=void 0}_removeToolbarPropertiesContainer(){var e;null!=(e=this._toolbarPropertiesContainer)&&e.remove(),this._toolbarPropertiesContainer=void 0,this._isToolbarPropertiesContainerOpen=!1,this._pdfState.isAnnotationConfigurationPropertiesEnabled=!1}_removeShapeDropdown(){var e;null!=(e=this._shapeDropdown)&&e.remove(),this._shapeDropdown=void 0,this._isShapeDropdownOpen=!1}_createGoBackButton(){var e=this.createToolbarButton({id:"annotationToolbarBackButton",iconClass:"a-annotation-toolbar-back-icon",tooltip:"Back",onClick:()=>this.handleBackClick()}),t=this.parentWrapper({});t.appendChild(e),this._toolbarContainer.appendChild(t)}parentWrapper(e){var t=document.createElement("div");return t.setAttribute("class",(PDF_VIEWER_CLASSNAMES.A_TOOLBAR_ITEM+" "+PDF_VIEWER_CLASSNAMES.A_TOOLBAR_TOOLTIP).trim()),t}_createToolbarPropertiesContainer(){this._toolbarPropertiesContainer=document.createElement("div"),this._toolbarPropertiesContainer.classList.add(PDF_VIEWER_CLASSNAMES.A_ANNOTATION_SHAPE_PROPERTIES_CONTAINER,PDF_VIEWER_CLASSNAMES.A_TOOLBAR_ITEMS),this._toolbarPropertiesContainer.style.display="none",this._toolbarPropertiesContainer.appendChild(this._createColorDropdown("Color",this._color,e=>{"custom"===e?alert("Open custom color dialog..."):(this._color=e,this.updateDrawConfig())})),this._toolbarPropertiesContainer.appendChild(this._createColorDropdown("Fill",this._fillColor,e=>{"custom"===e?alert("Open custom fill dialog..."):(this._fillColor=e,this.updateDrawConfig())},!0)),this._toolbarPropertiesContainer.appendChild(this._createDropdownSlider("Opacity",0,1,this._opacity,e=>Math.round(100*e)+"%",e=>{this._opacity=e,this.updateDrawConfig()})),this._toolbarPropertiesContainer.appendChild(this._createDropdownSlider("Thickness",1,10,this._thickness,e=>Math.round(e)+" pt",e=>{this._thickness=e,this.updateDrawConfig()})),this._toolbarPropertiesContainer.appendChild(this._createBorderDropdown("Border",this._borderStyle,e=>{this._borderStyle=e,this.updateDrawConfig()}))}_createColorDropdown(e,t,o,n=!1){let i=document.createElement("div");i.classList.add(PDF_VIEWER_CLASSNAMES.A_ANNOTATION_SHAPE_PROPERTIES),i.classList.add("Color"===e?PDF_VIEWER_CLASSNAMES.A_ANNOTATION_SHAPE_PROPERTIES_COLOR:PDF_VIEWER_CLASSNAMES.A_ANNOTATION_SHAPE_PROPERTIES_FILL),i.style.position="relative",i.style.display="flex",i.style.alignItems="center";var r=document.createElement("label");r.innerText=e+":",i.appendChild(r);let a=document.createElement("button"),s=(a.style.borderRadius="4px",a.style.border="1px solid #ccc",a.style.background=t,a.style.cursor="pointer",a.onclick=()=>{s.style.display="none"===s.style.display?"block":"none"},i.appendChild(a),document.createElement("div"));s.classList.add(PDF_VIEWER_CLASSNAMES.A_ANNOTATION_COLOR_PICKER);e=["#FF0000","#FF9900","#FFFF00","#00FF00","#00FFFF","#0000FF","#FF00FF","#FFFFFF","#C0C0C0","#000000"];n&&e.unshift("transparent");let l=document.createElement("div");l.style.display="grid",l.style.gridTemplateColumns="repeat(5, 24px)",l.style.gridGap="8px",s.appendChild(l),e.forEach(e=>{let t=document.createElement("div");t.classList.add(PDF_VIEWER_CLASSNAMES.A_ANNOTATION_COLOR_PICKER_OPTION),t.style.background="transparent"===e?`
          linear-gradient(45deg, #bbb 25%, transparent 25%) 0 0 / 8px 8px,
          linear-gradient(45deg, transparent 75%, #bbb 75%) 0 0 / 8px 8px,
          #fff`:e,t.onclick=()=>{a.style.background=e,this._deselectColorPicker(),t.classList.toggle("active"),s.style.display="none",o(e)},l.appendChild(t)});r=document.createElement("div");return r.style.display="flex",r.style.alignItems="center",r.style.marginTop="8px",r.style.cursor="pointer",r.innerHTML='<span>Custom Colors</span><span style="font-weight:bold;width:16px;text-align:center;">+</span>',r.onclick=()=>{s.style.display="none",o("custom")},s.appendChild(r),document.addEventListener("click",e=>{i.contains(e.target)||(s.style.display="none")}),i.appendChild(s),i}_createDropdownSlider(e,o,n,t,i,r){let a=document.createElement("div");a.classList.add(PDF_VIEWER_CLASSNAMES.A_ANNOTATION_SHAPE_PROPERTIES),a.classList.add("Opacity"===e?PDF_VIEWER_CLASSNAMES.A_ANNOTATION_SHAPE_PROPERTIES_OPACITY:PDF_VIEWER_CLASSNAMES.A_ANNOTATION_SHAPE_PROPERTIES_THICKNESS),a.style.position="relative",a.style.display="flex",a.style.alignItems="center";var s=document.createElement("label");s.innerText=e+":",a.appendChild(s);let l=document.createElement("button"),d=(l.style.display="flex",l.style.alignItems="center",l.style.cursor="pointer",l.style.border="1px solid #ccc",l.style.borderRadius="4px",l.style.padding="4px 8px",l.style.backgroundColor="#2e2e2e",l.style.color="#fff",t),p=(l.textContent=i(d),a.appendChild(l),document.createElement("div")),_=(p.classList.add(PDF_VIEWER_CLASSNAMES.A_ANNOTATION_DROPDOWN_SLIDER_CONTAINER),p.style.display="none",document.createElement("div")),c=(_.style.position="relative",_.style.height="4px",_.style.background="#888",_.style.borderRadius="2px",_.style.cursor="pointer",_.style.width="140px",p.appendChild(_),document.createElement("div")),h=(c.style.position="absolute",c.style.top="-5px",c.style.width="14px",c.style.height="14px",c.style.borderRadius="50%",c.style.background="#2e2e2e",c.style.cursor="grab",_.appendChild(c),document.createElement("div"));function E(e){var t=_.clientWidth,e=(e-o)/(n-o);c.style.left=e*t-c.clientWidth/2+"px"}h.style.textAlign="right",h.textContent=i(d),p.appendChild(h),E(t);let A=!1;return c.onpointerdown=e=>{A=!0,c.setPointerCapture(e.pointerId),c.style.cursor="grabbing"},c.onpointermove=e=>{var t;A&&(t=_.getBoundingClientRect(),e=e.clientX-t.left,e=Math.max(0,Math.min(t.width,e)),E(d=o+e/t.width*(n-o)),l.textContent=i(d),h.textContent=i(d),r(d))},c.onpointerup=e=>{A=!1,c.releasePointerCapture(e.pointerId),c.style.cursor="grab"},_.onclick=e=>{var t;e.target!==c&&(t=_.getBoundingClientRect(),e=e.clientX-t.left,e=Math.max(0,Math.min(t.width,e)),E(d=o+e/t.width*(n-o)),l.textContent=i(d),r(d))},l.onclick=()=>{p.style.display="none"===p.style.display?"":"none"},document.addEventListener("click",e=>{a.contains(e.target)||(p.style.display="none"),d===t&&E(t)}),a.appendChild(p),a}_createBorderDropdown(e,t,o){let n=document.createElement("div");n.classList.add(PDF_VIEWER_CLASSNAMES.A_ANNOTATION_SHAPE_PROPERTIES,PDF_VIEWER_CLASSNAMES.A_ANNOTATION_SHAPE_PROPERTIES_BORDER),n.style.position="relative",n.style.display="flex",n.style.alignItems="center";var i=document.createElement("label");i.textContent=e+":",n.appendChild(i);let r=document.createElement("button"),a=(r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.border="1px solid #ccc",r.style.borderRadius="4px",r.style.cursor="pointer",r.style.background="#2e2e2e",r.style.color="#fff",r.style.padding="4px 8px",r.style.minWidth="65px",r.textContent=t,n.appendChild(r),document.createElement("div"));return a.classList.add(PDF_VIEWER_CLASSNAMES.A_ANNOTATION_BORDER_DROPDOWN),a.style.display="none",n.appendChild(a),["Solid","Dashed","Dotted"].forEach(e=>{var t=document.createElement("div");t.classList.add(PDF_VIEWER_CLASSNAMES.A_ANNOTATION_BORDER_DROPDOWN_OPTION),t.innerHTML=`<div style="flex:1;height:0;border-top:2px ${"Solid"===e?"solid":"Dashed"===e?"dashed":"dotted"} #2e2e2e"></div>`,t.onclick=()=>{r.textContent=e,a.style.display="none",o(e)},a.appendChild(t)}),r.onclick=()=>{a.style.display="none"===a.style.display?"":"none"},document.addEventListener("click",e=>{n.contains(e.target)||(a.style.display="none")}),n}_selectShape(e,t){this._selectedShapeIcon=e,this._selectedShape=t,this._isShapeDropdownOpen=!1,this._shapeDropdown.style.display="none",this.updateDrawConfig();e=this._toolbarContainer.nextElementSibling;e&&(e.style.display=t?"flex":"none")}_toggleShapeDropdown(e){var t,o;this._isShapeDropdownOpen?(this._isShapeDropdownOpen=!1,this._shapeDropdown.style.display="none"):"none"===this._shapeDropdown.style.display?this._shapeDropdown.style.display="block":(o=null==(t=document.querySelector(`#${this._pdfState.containerId} .${PDF_VIEWER_CLASSNAMES.A_PDF_VIEWER} .`+PDF_VIEWER_CLASSNAMES.A_VIEWER_WRAPPER))?void 0:t.parentElement,t&&o&&(this._isShapeDropdownOpen=!0,o.insertBefore(this._shapeDropdown,t)))}handleBackClick(){this.destroy()}_deselectColorPicker(){var e=this._toolbarPropertiesContainer.querySelector("."+PDF_VIEWER_CLASSNAMES.A_ANNOTATION_COLOR_PICKER);null!=e&&e.querySelectorAll("."+PDF_VIEWER_CLASSNAMES.A_ANNOTATION_COLOR_PICKER_OPTION).forEach(e=>e.classList.remove("active"))}createToolbarButton(t){var e=document.createElement("button"),o=(e.classList.add("a-toolbar-button"),document.createElement("span"));return o.className="a-toolbar-icon "+t.iconClass,e.appendChild(o),e.addEventListener("click",()=>{var e;return null==(e=t.onClick)?void 0:e.call(t,null)}),e}destroy(){this._pdfState.off("ANNOTATION_CREATED",this._onAnnotationCreated),this._pdfState.isAnnotationEnabled=!1;var e=null==(e=document.querySelector(`#${this._pdfState.containerId} .${PDF_VIEWER_CLASSNAMES.A_TOOLBAR_BUTTON} .annotation-icon`))?void 0:e.parentElement;null!=e&&e.classList.remove("active"),this._removeToolbarContainer(),this._removeToolbarPropertiesContainer(),this._removeShapeDropdown(),this.toogleAnnotationDrawing(),this._pdfState.isAnnotationEnabled=!1}}export{AnnotationToolbar};
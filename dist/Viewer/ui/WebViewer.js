var __awaiter=this&&this.__awaiter||function(e,o,s,c){return new(s=s||Promise)(function(r,t){function a(e){try{n(c.next(e))}catch(e){t(e)}}function i(e){try{n(c.throw(e))}catch(e){t(e)}}function n(e){var t;e.done?r(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(a,i)}n((c=c.apply(e,o||[])).next())})};import{PDF_VIEWER_CLASSNAMES,PDF_VIEWER_IDS}from"../../constants/pdf-viewer-selectors";import PdfState from"./PDFState";import{debounce}from"lodash";import PageVirtualization from"./PDFPageVirtualization";import ZoomHandler from"./PDFZoomHandler";import{AnnotationService}from"../services/AnnotationService";import{SelectionManager}from"../manager/SelectionManager";import SearchBar from"./PDFSearchBar";import SearchHighlighter from"../manager/SearchHighlighter";import{Toolbar}from"./PDFToolbar";import{DownloadManager}from"../manager/PDFDownloadManager";class WebViewer{constructor(e,t,r,a){this._bindScrollHandler=this._onScroll.bind(this),this._pdfInstance=e,this._viewerOptions=t,this._pdfState=PdfState.getInstance(t.containerId);var i,e=new SelectionManager;let n=new SearchHighlighter(this._pdfState,this);new SearchBar(this._pdfState,(e,t)=>__awaiter(this,void 0,void 0,function*(){yield n.search(e,t,this._pdfState)}),n.prevMatch.bind(n),n.nextMatch.bind(n),n.getMatchStatus.bind(n)),this._pageVirtualization=new PageVirtualization(this._viewerOptions,r,a,this._pdfInstance.numPages,this,e,n),t.disableToolbar||(r=document.querySelector(`#${this._viewerOptions.containerId} #toolbar-container`),a=PdfState.getInstance(t.containerId),e=null!=(e=t.customToolbarItems)?e:[],i=null!=(i=t.toolbarOptions)?i:{},this._toolbar=t.customToolbar||new Toolbar(this,a,e,i),this._toolbar.render(r)),this._addEvents(),this._zoomHandler=new ZoomHandler(this._pdfState,this._pageVirtualization),this._annotationService=new AnnotationService(this._pdfState,this),this.ready.then(()=>{this.observer(e=>{this._pdfState.currentPage=e,this._updateCurrentPageInput()})}),this._downloadManager=new DownloadManager(this._annotationService,this._pdfState)}observer(t){let r=null;this._intersectionObserver||(this._intersectionObserver=new IntersectionObserver(e=>{var e=e.filter(e=>e.isIntersecting);e.length&&(e=e.reduce((e,t)=>e.intersectionRatio>t.intersectionRatio?e:t),(e=parseInt(e.target.id.split("-")[1],10))!==r)&&(r=e,t(e))},{root:document.querySelector(`#${this._viewerOptions.containerId} #`+PDF_VIEWER_IDS.MAIN_VIEWER_CONTAINER),threshold:0,rootMargin:"-50% 0px -50% 0px"}),this._pageVirtualization.pageObserver=this._intersectionObserver)}_addEvents(){var e=document.querySelector(`#${this._viewerOptions.containerId} #`+PDF_VIEWER_IDS.MAIN_VIEWER_CONTAINER);e&&e.addEventListener("scroll",this._bindScrollHandler)}_onScroll(e){debounce(()=>this._syncThumbnailScrollWithMainPageContainer(),600)()}_syncThumbnailScrollWithMainPageContainer(){var e=this.currentPageNumber,t=document.querySelector(`#${this._viewerOptions.containerId} .thumbnail.thumbnail-active`),t=(t&&t.classList.remove("thumbnail-active"),document.querySelector(`#${this._viewerOptions.containerId} [data-page-number="${e}"]`));t&&(t.classList.add("thumbnail-active"),t.scrollIntoView({block:"center",behavior:"smooth"}))}get visiblePageNumbers(){return this._pageVirtualization.visiblePages}get currentPageNumber(){return this._pdfState.currentPage}get totalPages(){var e;return null==(e=this._pdfState.pdfInstance)?void 0:e.numPages}get annotation(){return this._annotationService}toogleThumbnailViewer(){var e=null!=(e=this._cachedSideBarElement)?e:document.querySelector(`#${this._viewerOptions.containerId} .`+PDF_VIEWER_CLASSNAMES.A_SIDEBAR_CONTAINER);e?(this._cachedSideBarElement||(this._cachedSideBarElement=e),this._cachedSideBarElement.classList.contains("active")?this._cachedSideBarElement.classList.remove("active"):(this._cachedSideBarElement.classList.add("active"),this._syncThumbnailScrollWithMainPageContainer())):console.error(`Invalid sidebar container element ${e}.`)}nextPage(){void 0===this.totalPages?console.error(`nextPage: ${this.totalPages} is not a valid total page count.`):this.currentPageNumber<this.totalPages&&(this._pdfState.currentPage=this.currentPageNumber+1,this.goToPage(this.currentPageNumber))}previousPage(){1<this.currentPageNumber&&(this._pdfState.currentPage=this.currentPageNumber-1,this.goToPage(this.currentPageNumber))}firstPage(){1<this.currentPageNumber&&(this._pdfState.currentPage=1,this.goToPage(this.currentPageNumber))}lastPage(){void 0===this.totalPages?console.error(`lastPage: ${this.totalPages} is not a valid total page count.`):this.currentPageNumber<this.totalPages&&(this._pdfState.currentPage=this.totalPages,this.goToPage(this.currentPageNumber))}downloadPdf(){this._downloadManager.download()}search(){var e=document.querySelector(`#${this._viewerOptions.containerId} .a-search-container`);e&&e.classList.toggle("a-search-hidden")}zoomIn(){return __awaiter(this,void 0,void 0,function*(){yield this._zoomHandler.zoomIn()})}zoomOut(){return __awaiter(this,void 0,void 0,function*(){yield this._zoomHandler.zoomOut()})}goToPage(e){var t,r;1<=e&&e<=this.totalPages?null!=(t=this._pageVirtualization.cachedPagePosition.get(e))&&(r=document.querySelector(`#${this._viewerOptions.containerId} #`+PDF_VIEWER_IDS.MAIN_VIEWER_CONTAINER))&&(r.scrollTop=t,this._pdfState.currentPage=e,this._updateCurrentPageInput()):console.error("Invalid page number: "+e)}_updateCurrentPageInput(){var e=document.querySelector(`#${this._viewerOptions.containerId} #`+PDF_VIEWER_IDS.CURRENT_PAGE_INPUT);e&&(e.value=String(this.currentPageNumber))}toolbarButtonClick(e,t){return __awaiter(this,void 0,void 0,function*(){switch(e){case"firstPage":this.goToPage(1);break;case"lastPage":this.goToPage(this.totalPages);break;case"previousPage":this.goToPage(this.currentPageNumber-1);break;case"nextPage":this.goToPage(this.currentPageNumber+1);break;case"zoomIn":yield this.zoomIn();break;case"zoomOut":yield this.zoomOut();break;case"currentPageNumber":this._pdfState.currentPage=parseInt(t.target.value),"Enter"===t.key&&(t.target.blur(),this.goToPage(this.currentPageNumber),this._syncThumbnailScrollWithMainPageContainer())}})}destroy(){var e=document.querySelector(`#${this._viewerOptions.containerId} #`+PDF_VIEWER_IDS.MAIN_VIEWER_CONTAINER),e=(null!=e&&e.removeEventListener("scroll",this._bindScrollHandler),null!=(e=this._intersectionObserver)&&e.disconnect(),this._annotationService.destroy(),null!=(e=this._toolbar)&&e.destroy&&this._toolbar.destroy(),this._pageVirtualization.destroy(),null==(e=document.querySelector(`#${this._viewerOptions.containerId} .`+PDF_VIEWER_CLASSNAMES.A_PAGE_VIEW))?void 0:e.parentElement);e&&(e.innerHTML=""),this._pdfState.destroy()}}export default WebViewer;
var __awaiter=this&&this.__awaiter||function(e,s,o,h){return new(o=o||Promise)(function(i,t){function a(e){try{r(h.next(e))}catch(e){t(e)}}function n(e){try{r(h.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?i(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(a,n)}r((h=h.apply(e,s||[])).next())})};import TextLayer from"./PDFTextLayer";import PdfState from"./PDFState";import PageElement from"./PDFPageElement";import{throttle}from"lodash";import ThumbnailViewer from"./PDFThumbnailViewer";import{PDFLinkService}from"../services/LinkService";import AnnotationLayer from"./PDFAnnotationLayer";import{PDF_VIEWER_IDS}from"../../constants/pdf-viewer-selectors";import{AnnotationManager}from"../manager/AnnotationManager";class PageVirtualization{constructor(e,t,i,a,n,r,s,o=3){this._options=null,this._parentContainer=null,this._container=null,this._pageBuffer=3,this._renderedPages=new Set,this._lastScrollTop=0,this._pagePosition=new Map,this._bindOnScaleChange=this._onScaleChange.bind(this),this._isScaleChangeActive=!1,this._observer=null,this._scrollHandler=e=>{this._debouncedScrollHandler(this._isScaleChangeActive)},this._debouncedScrollHandler=throttle(i=>__awaiter(this,void 0,void 0,function*(){var e,t;i||(e=(t=this._container.scrollTop)>this._lastScrollTop,this._lastScrollTop=t,t=this._calculatePageFromScroll(t),yield this._updateVisiblePages(e,t))}),160),n.ready=new Promise(e=>this._resolveReady=e),this._options=e,this._totalPages=a,this._parentContainer=t,this._container=i.parentElement,this._pageBuffer=o,this._pdfState=PdfState.getInstance(e.containerId),this._pdf=this._pdfState.pdfInstance,this._pdfViewer=n,this._selectionManager=r,this._searchHighlighter=s,this.calculatePagePositioning().then(()=>__awaiter(this,void 0,void 0,function*(){var e;null==this.isThereSpecificPageToRender||null==this.isThereSpecificPageToRender?(yield this._renderInitialPages(),this._attachScrollListener()):yield this._renderInitialPages(),null!=(e=null!=(e=null==(e=this._options)?void 0:e.toolbarOptions)?e:{})&&e.showThumbnail&&(yield this.generateThumbnail()),this._resolveReady()}))}set pageObserver(e){this._observer=e}get visiblePages(){return new Set(this._renderedPages)}get isThereSpecificPageToRender(){var e;return null==(e=this._options)?void 0:e.renderSpecificPageOnly}get cachedPagePosition(){return this._pagePosition}_attachScrollListener(){this._container&&(this._pdfState.on("scaleChange",this._bindOnScaleChange),this._container.addEventListener("scroll",this._scrollHandler))}_onScaleChange(){this._isScaleChangeActive=!0,setTimeout(()=>this._isScaleChangeActive=!1,300)}_calculatePagesToFillViewport(){return __awaiter(this,void 0,void 0,function*(){if(!this._container)return 0;var t=this._container.getBoundingClientRect().height;let i=0,a=0;for(let e=1;e<=this._totalPages;e++){var n=yield this._pdf.getPage(e),r=this._pdfState.scale,n=n.getViewport({scale:r}).height;if(t<n){a++;break}if((i+=n)>=t){a++;break}a++}return a})}_renderInitialPages(){return __awaiter(this,void 0,void 0,function*(){var e=this.isThereSpecificPageToRender;if(null!=e)this._renderedPages.add(e),yield this._renderPage(e);else{var t,i=yield this._calculatePagesToFillViewport(),a=[];for(let e=1;e<=i;e++)a.push(e),this._renderedPages.add(e);for(t of a)yield this._renderPage(t)}})}generateThumbnail(){return __awaiter(this,void 0,void 0,function*(){var t=this.isThereSpecificPageToRender,i=ThumbnailViewer.createThumbnailContainer(this._options.containerId),a=new PDFLinkService({pdfState:this._pdfState,pdfViewer:this._pdfViewer});for(let e=null!=t?t:1;e<=(null!=t?t:this._totalPages);e++){var n=new ThumbnailViewer({container:i,pageNumber:e,pdfDocument:this._pdf,linkService:a});yield n.initThumbnail(),e!==t&&e!==this._pdfState.currentPage||(n.activeThumbnail=this._pdfState.currentPage)}})}calculatePagePositioning(){return __awaiter(this,void 0,void 0,function*(){var t=this._pdfState.scale;let i=PageElement.gap,a=Number.NEGATIVE_INFINITY;var n=this.isThereSpecificPageToRender;for(let e=null!=n?n:1;e<=(null!=n?n:this._pdf.numPages);e++){var r=(yield this._pdf.getPage(e)).getViewport({scale:t});this._pagePosition.set(e,i),i+=r.height+PageElement.gap,a=Math.max(a,r.width)}return this._setContainerHeight(i+PageElement.gap),this._setContainerWidth(a+2*PageElement.gap),this._pagePosition})}_setContainerHeight(e){var t;null!=(t=this._container)&&t.firstChild&&(this._container.firstChild.style.height=e+"px")}_setContainerWidth(e){var t;null!=(t=this._container)&&t.firstChild&&(this._container.firstChild.style.width=e+"px")}_calculatePageFromScroll(e){var t=Array.from(this._pagePosition.entries()).sort((e,t)=>e[1]-t[1]);let i=0,a=t.length-1;for(;i<=a;){var n=Math.floor((i+a)/2),[,r]=t[n];e<r?a=n-1:i=n+1}return t[Math.max(a,0)][0]}_updateVisiblePages(e,i){return __awaiter(this,void 0,void 0,function*(){var e,t=this._getPagesInBuffer(i);for(e of t)this._renderedPages.has(e)||(yield this._renderPage(e),this._renderedPages.add(e));this._cleanupOutOfBufferPages(t)})}_getPagesInBuffer(e){if(this.isThereSpecificPageToRender)return[];var t=Math.max(1,e-this._pageBuffer),i=Math.min(this._totalPages,e+this._pageBuffer),a=[];for(let e=t;e<=i;e++)a.push(e);return a}_renderPage(s){return __awaiter(this,void 0,void 0,function*(){if(this._container){let i=yield this._pdf.getPage(s);var e=1<this._pdfState.scale?1:this._pdfState.scale;let a=i.getViewport({scale:e}),n=PageElement.createPageContainerDiv(s,a,this._pagePosition);n.style.backgroundColor="white",null!=(e=this._container.firstChild)&&e.appendChild(n);var[e,t]=PageElement.createCanvas(a),r=document.createElement("div"),e=(r.setAttribute("id","canva-presentation"),r.appendChild(e),n.appendChild(r),document.createElement("div")),r=(e.setAttribute("id","a-zoomed-page-image-container"),e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width=a.width+"px",e.style.height=a.height+"px",e.style.overflow="hidden",r.appendChild(e),{canvasContext:t,viewport:a,annotationMode:2});1<this._pdfState.scale&&this.updatePageBuffers(s),i.render(r).promise.then(()=>__awaiter(this,void 0,void 0,function*(){var e,t;this._options&&!this._options.disableTextSelection&&(a=i.getViewport({scale:this._pdfState.scale}),[e,t]=yield new TextLayer(n,i,a).createTextLayer(),yield new AnnotationLayer(n,i,a).createAnnotationLayer(this._pdfViewer,this._pdf),this._pdfState.isAnnotationEnabled&&this._pdfState.isAnnotationConfigurationPropertiesEnabled&&t&&(t.style.cursor="crosshair",t.style.pointerEvents="all"),this._searchHighlighter.registerPage(s),this._pdfViewer.annotation.isAnnotationManagerRegistered(s)||this._pdfViewer.annotation.registerAnnotationManager(s,new AnnotationManager(t,this._pdfState,this._selectionManager)),1<this._pdfState.scale&&(yield this.appendHighResImageToPageContainer(s)),this._observer)&&this._observer.observe(n)}))}})}_cleanupOutOfBufferPages(e){var t,i=Math.min(...e),a=Math.max(...e);for(t of this._renderedPages)(t<i||t>a)&&(this._pdfViewer.annotation.unregisterAnnotationManager(t),this._searchHighlighter.deregisterPage(t),this._removePage(t),this._renderedPages.delete(t))}_getViewport(e){return __awaiter(this,void 0,void 0,function*(){return(yield this._pdf.getPage(e)).getViewport({scale:this._pdfState.scale})})}_removePage(e){var t=document.querySelector(`#${null==(t=this._options)?void 0:t.containerId} #pageContainer-`+e);t&&(this._observer&&this._observer.unobserve(t),t.remove())}redrawVisiblePages(e){return __awaiter(this,void 0,void 0,function*(){var e=this._renderedPages;if(this.isThereSpecificPageToRender)yield this._renderPage(this.isThereSpecificPageToRender),yield this.appendHighResImageToPageContainer(this.isThereSpecificPageToRender);else for(var t of e)yield this.appendHighResImageToPageContainer(t)})}updatePageBuffers(){return __awaiter(this,arguments,void 0,function*(e=null){if(this._container)if(null!==e){var t,i,a=document.querySelector(`#${null==(a=this._options)?void 0:a.containerId} #pageContainer-`+e);a&&(t=yield this._pdf.getPage(e),i=this._pdfState.scale,t=t.getViewport({scale:i}),i=this._pagePosition.get(e)||0,a.style.top=i+"px",a.style.height=t.height+"px",a.style.width=t.width+"px",(e=a.querySelector("canvas"))&&(e.style.width=t.width+"px",e.style.height=t.height+"px"),(i=a.querySelector("#"+PDF_VIEWER_IDS.ANNOTATION_DRAWING_LAYER))&&(i.style.width=t.width+"px",i.style.height=t.height+"px"),a=null==e?void 0:e.nextElementSibling)&&(a.style.width=t.width+"px",a.style.height=t.height+"px",a.innerHTML="")}else{var n=document.querySelectorAll(`#${null==(i=this._options)?void 0:i.containerId} .a-page-view`);if(n)for(let t=0;t<n.length;t++){let e=parseInt(n[t].id.split("-")[1]);var r=yield this._pdf.getPage(e),s=this._pdfState.scale,r=r.getViewport({scale:s}),s=this._pagePosition.get(e)||0,s=(n[t].style.top=s+"px",n[t].style.height=r.height+"px",n[t].style.width=r.width+"px",n[t].querySelector("canvas")),o=(s&&(s.style.width=r.width+"px",s.style.height=r.height+"px"),n[t].querySelector("#"+PDF_VIEWER_IDS.ANNOTATION_DRAWING_LAYER)),o=(o&&(o.style.width=r.width+"px",o.style.height=r.height+"px"),null==s?void 0:s.nextElementSibling);o&&(o.style.width=r.width+"px",o.style.height=r.height+"px",o.innerHTML="")}}})}appendHighResImageToPageContainer(a){return __awaiter(this,void 0,void 0,function*(){var e=yield this._pdf.getPage(a),t=this._pdfState.scale,t=e.getViewport({scale:t}),i=document.createElement("img"),[t,,]=(i.style.width=t.width+"px",i.style.height=t.height+"px",yield this._renderHighResImage(t,e)),e=(i.src=t,document.querySelector(`#${this._pdfState.containerId} #pageContainer-`+a));e&&(t=e.querySelector("#canva-presentation"))&&(e=t.querySelector("#a-zoomed-page-image-container"))&&e.appendChild(i)})}_renderHighResImage(i,a){return __awaiter(this,void 0,void 0,function*(){var[e,t]=PageElement.createCanvas(i);return yield a.render({canvasContext:t,viewport:i,annotationMode:2}).promise,[e.toDataURL("image/png"),e]})}destroy(){var e;null!=(e=this._container)&&e.removeEventListener("scroll",this._scrollHandler),this._pdfState.off("scaleChange",this._bindOnScaleChange)}}export default PageVirtualization;
var __awaiter=this&&this.__awaiter||function(e,o,s,h){return new(s=s||Promise)(function(a,t){function i(e){try{n(h.next(e))}catch(e){t(e)}}function r(e){try{n(h.throw(e))}catch(e){t(e)}}function n(e){var t;e.done?a(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(i,r)}n((h=h.apply(e,o||[])).next())})};import WebUiUtils from"../../utils/WebUiUtils";import{aPdfViewerClassNames,aPdfViewerIds}from"../../constant/ElementIdClass";import throttle from"lodash/throttle";import PdfState from"./PdfState";import Toolbar from"./Toolbar";import{debounce}from"lodash";import PageVirtualization from"./PageVirtualization";import ZoomHandler from"./ZoomHandler";import{AnnotationService}from"../service/AnnotationService";import{SelectionManager}from"../manager/SelectionManager";import SearchBar from"./SearchBar";import SearchHighlighter from"../manager/SearchHighlighter";class WebViewer{constructor(e,t,a,i){this.__pdfInstance=e,this.__viewerOptions=t,this.__Observer=throttle(WebUiUtils.Observer,200),this.__pdfState=PdfState.getInstance(t.containerId);e=new SelectionManager;SearchHighlighter.viewer=this,new SearchBar(this.__pdfState,(e,t)=>__awaiter(this,void 0,void 0,function*(){yield SearchHighlighter.search(e,t,this.__pdfState)}),SearchHighlighter.prevMatch.bind(SearchHighlighter),SearchHighlighter.nextMatch.bind(SearchHighlighter),SearchHighlighter.getMatchStatus.bind(SearchHighlighter)),this.__pageVirtualization=new PageVirtualization(this.__viewerOptions,a,i,this.__pdfInstance.numPages,this,e,SearchHighlighter),new Toolbar(this.__viewerOptions.containerId,null!=(t=this.__viewerOptions.customToolbarItems)?t:[],this,e),this.addEvents(),this.__zoomHandler=new ZoomHandler(this.__pdfState,this.__pageVirtualization),this.__annotationService=new AnnotationService(this.__pdfState,this)}addEvents(){var e=document.querySelector(`#${this.__viewerOptions.containerId} #`+aPdfViewerIds._MAIN_VIEWER_CONTAINER);e&&e.addEventListener("scroll",()=>{this.__Observer(e=>{this.__pdfState.currentPage=e,this.updateCurrentPageInput()},this.__viewerOptions.containerId),debounce(()=>{this.syncThumbnailScrollWithMainPageContainer()},600)()})}syncThumbnailScrollWithMainPageContainer(){var e=this.currentPageNumber,t=document.querySelector(".thumbnail.thumbnail-active"),t=(t&&t.classList.remove("thumbnail-active"),document.querySelector(`[data-page-number="${e}"]`));t&&(t.classList.add("thumbnail-active"),t.scrollIntoView({block:"center",behavior:"smooth"}))}get currentPageNumber(){return this.__pdfState.currentPage}get totalPages(){var e;return null==(e=this.__pdfState.pdfInstance)?void 0:e.numPages}get annotation(){return this.__annotationService}toogleThumbnailViewer(){var e=null!=(e=this.__cachedSideBarElement)?e:document.querySelector(`#${this.__viewerOptions.containerId} .`+aPdfViewerClassNames._A_SIDEBAR_CONTAINER);e?(this.__cachedSideBarElement||(this.__cachedSideBarElement=e),this.__cachedSideBarElement.classList.contains("active")?this.__cachedSideBarElement.classList.remove("active"):(this.__cachedSideBarElement.classList.add("active"),this.syncThumbnailScrollWithMainPageContainer())):console.error(`Invalid sidebar container element ${e}.`)}nextPage(){void 0===this.totalPages?console.error(`nextPage: ${this.totalPages} is not a valid total page count.`):this.currentPageNumber<this.totalPages&&(this.__pdfState.currentPage=this.currentPageNumber+1,this.goToPage(this.currentPageNumber))}previousPage(){1<this.currentPageNumber&&(this.__pdfState.currentPage=this.currentPageNumber-1,this.goToPage(this.currentPageNumber))}firstPage(){1<this.currentPageNumber&&(this.__pdfState.currentPage=1,this.goToPage(this.currentPageNumber))}lastPage(){void 0===this.totalPages?console.error(`lastPage: ${this.totalPages} is not a valid total page count.`):this.currentPageNumber<this.totalPages&&(this.__pdfState.currentPage=this.totalPages,this.goToPage(this.currentPageNumber))}search(){var e=document.querySelector(`#${this.__viewerOptions.containerId} .a-search-container`);e&&e.classList.toggle("a-search-hidden")}zoomIn(){return __awaiter(this,void 0,void 0,function*(){yield this.__zoomHandler.zoomIn()})}zoomOut(){return __awaiter(this,void 0,void 0,function*(){yield this.__zoomHandler.zoomOut()})}goToPage(e){var t,a;1<=e&&e<=this.totalPages?null!=(t=this.__pageVirtualization.cachedPagePosition.get(e))&&(a=document.querySelector(`#${this.__viewerOptions.containerId} #`+aPdfViewerIds._MAIN_VIEWER_CONTAINER))&&(a.scrollTop=t,this.__pdfState.currentPage=e,this.updateCurrentPageInput()):console.error("Invalid page number: "+e)}updateCurrentPageInput(){var e=document.querySelector(`#${this.__viewerOptions.containerId} #`+aPdfViewerIds._CURRENT_PAGE_INPUT);e&&(e.value=String(this.currentPageNumber))}toolbarButtonClick(e,t){return __awaiter(this,void 0,void 0,function*(){switch(e){case"firstPage":this.goToPage(1);break;case"lastPage":this.goToPage(this.totalPages);break;case"previousPage":this.goToPage(this.currentPageNumber-1);break;case"nextPage":this.goToPage(this.currentPageNumber+1);break;case"zoomIn":yield this.zoomIn();break;case"zoomOut":yield this.zoomOut();break;case"currentPageNumber":this.__pdfState.currentPage=parseInt(t.target.value),"Enter"===t.key&&(t.target.blur(),this.goToPage(this.currentPageNumber),this.syncThumbnailScrollWithMainPageContainer())}})}}export default WebViewer;